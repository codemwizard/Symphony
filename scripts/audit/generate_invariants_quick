#!/usr/bin/env python3
"""
generate_invariants_quick

Deterministically generates docs/invariants/INVARIANTS_QUICK.md from
docs/invariants/INVARIANTS_MANIFEST.yml.

Design goals:
- dependency-free (no PyYAML)
- deterministic output (no timestamps)
- stable ordering by INV numeric id
"""
from __future__ import annotations
import re
from pathlib import Path

MANIFEST = Path("docs/invariants/INVARIANTS_MANIFEST.yml")
OUT = Path("docs/invariants/INVARIANTS_QUICK.md")

def parse_manifest(text: str):
    """
    Minimal parser for a constrained manifest:
    - top-level list of entries
    - each entry starts with: - id: INV-###
    - subsequent indented "key: value" lines belong to that entry
    """
    entries=[]
    cur=None
    for line in text.splitlines():
        if re.match(r'^\s*-\s+id:\s*', line):
            if cur:
                entries.append(cur)
            cur={"id": line.split("id:",1)[1].strip().strip('"').strip("'")}
            continue
        m=re.match(r'^\s+(\w+):\s*(.*)$', line)
        if m and cur is not None:
            k=m.group(1)
            v=m.group(2).strip()
            cur[k]=v
    if cur:
        entries.append(cur)
    return entries

def norm(v: str) -> str:
    return (v or "").strip().strip('"').strip("'")

def inv_num(iid: str) -> int:
    m=re.search(r'INV-(\d{3})', iid or "")
    return int(m.group(1)) if m else 0

def main():
    if not MANIFEST.exists():
        raise SystemExit(f"Manifest not found: {MANIFEST}")

    entries = parse_manifest(MANIFEST.read_text(encoding="utf-8", errors="ignore"))
    entries.sort(key=lambda e: inv_num(e.get("id","INV-000")))

    lines=[]
    lines.append("# Invariants Quick Reference")
    lines.append("")
    lines.append(f"_Generated from `{MANIFEST}` (do not edit by hand)._")
    lines.append("")
    lines.append("| ID | Status | Severity | Title | Owners | Verification |")
    lines.append("|---|---|---|---|---|---|")

    for e in entries:
        iid=norm(e.get("id",""))
        status=norm(e.get("status",""))
        severity=norm(e.get("severity",""))
        title=norm(e.get("title",""))
        owners=norm(e.get("owners",""))
        ver=norm(e.get("verification",""))
        lines.append(f"| {iid} | {status} | {severity} | {title} | {owners} | {ver} |")

    OUT.write_text("\n".join(lines) + "\n", encoding="utf-8")

if __name__ == "__main__":
    main()
