phase: '1'
task_id: TSK-P1-027
title: Range-only Diff Parity Hardening (follow-on to TSK-P1-021)
owner_role: INVARIANTS_CURATOR
status: planned
depends_on:
- TSK-P1-021
touches:
- scripts/lib/git_diff_range_only.sh
- scripts/lib/git_diff_dev.sh
- scripts/audit/lib/parity_critical_scripts.sh
- scripts/audit/prepare_invariants_curator_inputs.sh
- scripts/audit/verify_diff_semantics_parity.sh
- scripts/audit/test_diff_semantics_parity.sh
- scripts/audit/tests/**
- docs/operations/AGENTIC_SDLC_PHASE1_POLICY.md
- docs/plans/phase1/TSK-P1-027_range_only_diff_parity_hardening/PLAN.md
- docs/plans/phase1/TSK-P1-027_range_only_diff_parity_hardening/EXEC_LOG.md
- tasks/TSK-P1-027/meta.yml
invariants:
- INV-105
- INV-081
work:
- Introduce dedicated range-only helper contract for parity-critical scripts.
- Move staged/worktree helper functions to a non-parity helper surface.
- Define one canonical parity-critical script list and require all parity verifiers/tests to consume it.
- Explicitly classify staged preflight helpers as non parity-critical surfaces.
- Enforce that parity-critical scripts source only range-only helper surfaces.
- Enforce banned-command policy for parity-critical scripts (`git diff --cached`, `git status`, `git ls-files -m`, and raw worktree/staged helper calls).
- Add semantic parity acceptance tests for staged/worktree immunity and changed-file equivalence.
- Align verifier critical-list semantics with range-only policy.
acceptance_criteria:
- Parity-critical scripts cannot call staged/worktree helper APIs.
- Staged preflight scripts are excluded from parity-critical script lists.
- A single canonical parity-critical list is used by verifier and parity test harnesses.
- Parity verifier enforces source boundary: parity-critical scripts may source range-only helper(s) and may not source dev/staged helper surfaces.
- verify_diff_semantics_parity fails on forbidden helper sourcing and staged/worktree helper calls.
- verify_diff_semantics_parity fails on banned direct git command patterns in parity-critical scripts.
- test_diff_semantics_parity proves staged/worktree changes do not affect parity-critical changed-file decisions.
- pre_ci and CI produce equivalent changed-file decisions for parity-critical gates with evidence hash parity.
verification:
- bash scripts/audit/test_diff_semantics_parity.sh
- bash scripts/audit/verify_diff_semantics_parity.sh
- bash scripts/audit/verify_remediation_trace.sh
- RUN_PHASE1_GATES=1 bash scripts/dev/pre_ci.sh
evidence:
- evidence/phase1/git_diff_semantics.json
failure_modes:
- Range-only policy declared but staged/worktree helpers remain reachable from parity-critical scripts.
- Verifier checks helper sourcing only and misses semantic staged/worktree regression.
- Parity-critical list still includes staged-preflight scripts after range-only policy hardening.
- Parity-critical lists drift between verifier/test scripts and create split-brain enforcement.
- Diff-mode drift returns between local and CI.
must_read:
- docs/plans/phase0/TSK-P0-152_diff_semantics_canonicalization/PLAN.md
- docs/plans/phase0/TSK-P0-154_refactor_diff_based_gates/PLAN.md
- docs/plans/phase0/TSK-P0-155_diff_semantics_regression_verifier/PLAN.md
implementation_plan: docs/plans/phase1/TSK-P1-027_range_only_diff_parity_hardening/PLAN.md
implementation_log: docs/plans/phase1/TSK-P1-027_range_only_diff_parity_hardening/EXEC_LOG.md
notes: Hardens canonical parity intent from P0-152/154/155 by making staged/worktree access impossible in parity-critical script paths.
client: codex_cli
assigned_agent: invariants_curator
model: <UNASSIGNED>
