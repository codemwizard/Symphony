# Invariants Implemented

These invariants are **implemented** when they are (a) described, and (b) have at least one concrete enforcement/verification evidence link below. If evidence is missing, downgrade the manifest status to `roadmap` and add a verification hook.

_Generated mechanically from `docs/invariants/INVARIANTS_MANIFEST.yml`._

| ID | Aliases | Severity | Title | Owners | Verification (manifest) | Evidence links |
|---|---|---|---|---|---|---|
| INV-001 | I-MIG-02 | P0 | Applied migrations are immutable (checksum ledger) | team-db | scripts/db/migrate.sh checksum check; run via scripts/db/verify_invariants.sh | [`scripts/db/migrate.sh L7-L11`](../../scripts/db/migrate.sh#L7-L11)<br>[`scripts/db/verify_invariants.sh L22-L26`](../../scripts/db/verify_invariants.sh#L22-L26)<br>[`scripts/db/ci_invariant_gate.sql L9-L13`](../../scripts/db/ci_invariant_gate.sql#L9-L13) |
| INV-002 | I-MIG-03 | P0 | Migration files must not contain top-level BEGIN/COMMIT | team-db | scripts/db/lint_migrations.sh; run via scripts/db/verify_invariants.sh | [`scripts/db/lint_migrations.sh L1-L5`](../../scripts/db/lint_migrations.sh#L1-L5)<br>[`scripts/db/verify_invariants.sh L22-L26`](../../scripts/db/verify_invariants.sh#L22-L26)<br>[`scripts/db/migrate.sh L66-L70`](../../scripts/db/migrate.sh#L66-L70) |
| INV-003 | I-MIG-04 | P0 | Fix forward only: changes via new migrations, never by editing applied ones | team-db | Same mechanical enforcement as INV-001 (checksum immutability) | [`scripts/db/ci_invariant_gate.sql L9-L13`](../../scripts/db/ci_invariant_gate.sql#L9-L13)<br>[`scripts/db/migrate.sh L7-L11`](../../scripts/db/migrate.sh#L7-L11)<br>[`scripts/db/lint_migrations.sh L1-L5`](../../scripts/db/lint_migrations.sh#L1-L5) |
| INV-005 | I-SEC-01 | P0 | Deny-by-default privileges (revoke-first posture) | team-platform | schema/migrations/0004_privileges.sql; scripts/db/ci_invariant_gate.sql checks schema/public privileges | [`schema/migrations/0004_privileges.sql L1-L4`](../../schema/migrations/0004_privileges.sql#L1-L4)<br>[`scripts/db/ci_invariant_gate.sql L86-L90`](../../scripts/db/ci_invariant_gate.sql#L86-L90)<br>[`scripts/db/migrate.sh L31-L35`](../../scripts/db/migrate.sh#L31-L35) |
| INV-006 | I-SEC-02 | P0 | No runtime DDL: PUBLIC/runtime roles must not have CREATE on schema public | team-platform | scripts/db/ci_invariant_gate.sql section 'No runtime DDL' (has_schema_privilege(...,'CREATE')) | [`scripts/db/ci_invariant_gate.sql L10-L14`](../../scripts/db/ci_invariant_gate.sql#L10-L14)<br>[`schema/migrations/0001_init.sql L16-L20`](../../schema/migrations/0001_init.sql#L16-L20)<br>[`schema/migrations/0002_outbox_functions.sql L7-L11`](../../schema/migrations/0002_outbox_functions.sql#L7-L11) |
| INV-007 | I-SEC-03 | P0 | Runtime roles are NOLOGIN templates; services assume them via SET ROLE | team-platform | schema/migrations/0003_roles.sql creates roles NOLOGIN; TODO: add CI gate for rolcanlogin | [`schema/migrations/0003_roles.sql L7-L11`](../../schema/migrations/0003_roles.sql#L7-L11)<br>[`schema/migrations/0001_init.sql L1-L5`](../../schema/migrations/0001_init.sql#L1-L5)<br>[`schema/migrations/0004_privileges.sql L6-L10`](../../schema/migrations/0004_privileges.sql#L6-L10) |
| INV-008 | I-SEC-04 | P0 | SECURITY DEFINER functions must pin search_path to pg_catalog, public | team-platform | scripts/db/lint_search_path.sh; run via scripts/db/verify_invariants.sh | [`scripts/db/lint_search_path.sh L1-L5`](../../scripts/db/lint_search_path.sh#L1-L5)<br>[`scripts/db/verify_invariants.sh L23-L27`](../../scripts/db/verify_invariants.sh#L23-L27)<br>[`schema/migrations/0002_outbox_functions.sql L27-L31`](../../schema/migrations/0002_outbox_functions.sql#L27-L31) |
| INV-010 | I-SEC-06 | P0 | Runtime roles have no direct DML on core tables; writes happen via DB API functions | team-platform | scripts/db/ci_invariant_gate.sql section 'Runtime roles have no direct table privileges on outbox tables' | [`scripts/db/ci_invariant_gate.sql L21-L25`](../../scripts/db/ci_invariant_gate.sql#L21-L25)<br>[`schema/migrations/0002_outbox_functions.sql L1-L4`](../../schema/migrations/0002_outbox_functions.sql#L1-L4)<br>[`schema/migrations/0004_privileges.sql L29-L33`](../../schema/migrations/0004_privileges.sql#L29-L33) |
| INV-011 | I-OB-01 | P0 | Outbox enqueue is idempotent on (instruction_id, idempotency_key) | team-db | schema/migrations/0002_outbox_functions.sql unique constraint + enqueue_payment_outbox(); TODO: add behavioral test to CI | [`schema/migrations/0002_outbox_functions.sql L47-L51`](../../schema/migrations/0002_outbox_functions.sql#L47-L51)<br>[`scripts/db/ci_invariant_gate.sql L206-L210`](../../scripts/db/ci_invariant_gate.sql#L206-L210)<br>[`scripts/db/verify_invariants.sh L35-L39`](../../scripts/db/verify_invariants.sh#L35-L39) |
| INV-012 | I-OB-02 | P0 | Outbox claim uses FOR UPDATE SKIP LOCKED and only due/unleased or expired rows | team-db | schema/migrations/0002_outbox_functions.sql claim_outbox_batch() uses SKIP LOCKED; TODO: add behavioral test to CI | [`schema/migrations/0002_outbox_functions.sql L140-L144`](../../schema/migrations/0002_outbox_functions.sql#L140-L144)<br>[`scripts/db/ci_invariant_gate.sql L21-L25`](../../scripts/db/ci_invariant_gate.sql#L21-L25)<br>[`scripts/db/migrate.sh L60-L64`](../../scripts/db/migrate.sh#L60-L64) |
| INV-013 | I-OB-03 | P0 | Strict lease fencing: completion requires matching claimed_by + lease_token and non-expired lease | team-db | schema/migrations/0002_outbox_functions.sql complete_outbox_attempt() validates lease; TODO: add behavioral test to CI | [`schema/migrations/0002_outbox_functions.sql L154-L158`](../../schema/migrations/0002_outbox_functions.sql#L154-L158)<br>[`scripts/db/lint_migrations.sh L12-L16`](../../scripts/db/lint_migrations.sh#L12-L16)<br>[`scripts/db/migrate.sh L4-L8`](../../scripts/db/migrate.sh#L4-L8) |
| INV-014 | I-OB-04 | P0 | payment_outbox_attempts is append-only; no UPDATE/DELETE | team-db | schema/migrations/0001_init.sql trigger denies mutation; scripts/db/ci_invariant_gate.sql validates trigger exists | [`scripts/db/ci_invariant_gate.sql L18-L22`](../../scripts/db/ci_invariant_gate.sql#L18-L22)<br>[`schema/migrations/0001_init.sql L131-L135`](../../schema/migrations/0001_init.sql#L131-L135)<br>[`schema/migrations/0004_privileges.sql L30-L34`](../../schema/migrations/0004_privileges.sql#L30-L34) |
| INV-015 | I-OB-05 | P0 | Outbox retry ceiling is finite | team-db | scripts/db/ci_invariant_gate.sql verifies symphony.outbox_retry_ceiling GUC and >=1 | [`scripts/db/ci_invariant_gate.sql L21-L25`](../../scripts/db/ci_invariant_gate.sql#L21-L25)<br>[`schema/migrations/0002_outbox_functions.sql L5-L9`](../../schema/migrations/0002_outbox_functions.sql#L5-L9)<br>[`schema/migrations/0001_init.sql L1-L5`](../../schema/migrations/0001_init.sql#L1-L5) |
| INV-016 | I-POL-01 | P0 | policy_versions exists and supports boot query shape (is_active=true) | team-platform | scripts/db/ci_invariant_gate.sql checks policy_versions exists and has is_active column | [`scripts/db/ci_invariant_gate.sql L8-L12`](../../scripts/db/ci_invariant_gate.sql#L8-L12)<br>[`scripts/db/migrate.sh L7-L11`](../../scripts/db/migrate.sh#L7-L11)<br>[`schema/migrations/0005_policy_versions.sql L1-L4`](../../schema/migrations/0005_policy_versions.sql#L1-L4) |
| INV-017 | I-POL-02 | P0 | policy_versions.checksum is NOT NULL | team-platform | scripts/db/ci_invariant_gate.sql asserts checksum column is NOT NULL | [`scripts/db/ci_invariant_gate.sql L9-L13`](../../scripts/db/ci_invariant_gate.sql#L9-L13)<br>[`scripts/db/migrate.sh L10-L14`](../../scripts/db/migrate.sh#L10-L14)<br>[`scripts/db/lint_migrations.sh L10-L14`](../../scripts/db/lint_migrations.sh#L10-L14) |
| INV-018 | I-POL-03 | P0 | Single ACTIVE policy row enforced by unique predicate index | team-platform | scripts/db/ci_invariant_gate.sql asserts unique index on policy_versions where status='ACTIVE' | [`scripts/db/ci_invariant_gate.sql L8-L12`](../../scripts/db/ci_invariant_gate.sql#L8-L12)<br>[`scripts/db/verify_invariants.sh L51-L55`](../../scripts/db/verify_invariants.sh#L51-L55)<br>[`schema/migrations/0001_init.sql L69-L73`](../../schema/migrations/0001_init.sql#L69-L73) |
