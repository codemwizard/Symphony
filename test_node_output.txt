
> symphony@1.0.0 test:node
> node --import ./tests/loader.mjs --test tests/unit/*.spec.ts tests/*.test.js

TAP version 13
# Subtest: ConfigGuard Module
    # Subtest: Module Exports
        # Subtest: should have ConfigGuard class
        ok 1 - should have ConfigGuard class
          ---
          duration_ms: 2.296966
          ...
        # Subtest: should have DB_CONFIG_GUARDS
        ok 2 - should have DB_CONFIG_GUARDS
          ---
          duration_ms: 44.853702
          ...
        # Subtest: should have CRYPTO_GUARDS
        ok 3 - should have CRYPTO_GUARDS
          ---
          duration_ms: 0.970594
          ...
        1..3
    ok 1 - Module Exports
      ---
      duration_ms: 61.190005
      type: 'suite'
      ...
    # Subtest: DB_CONFIG_GUARDS
        # Subtest: should include all required database config keys
        ok 1 - should include all required database config keys
          ---
          duration_ms: 185.777836
          ...
        # Subtest: should mark DB_PASSWORD as sensitive
        ok 2 - should mark DB_PASSWORD as sensitive
          ---
          duration_ms: 1.082924
          ...
        1..2
    ok 2 - DB_CONFIG_GUARDS
      ---
      duration_ms: 187.587006
      type: 'suite'
      ...
    # Subtest: PROD_CRYPTO_GUARDS
        # Subtest: should include required KMS config keys
        ok 1 - should include required KMS config keys
          ---
          duration_ms: 51.739503
          ...
        1..1
    ok 3 - PROD_CRYPTO_GUARDS
      ---
      duration_ms: 52.12956
      type: 'suite'
      ...
    1..3
ok 1 - ConfigGuard Module
  ---
  duration_ms: 302.941002
  type: 'suite'
  ...
# KeyManager tests loaded successfully
# Subtest: KeyManager Module
    # Subtest: Module Exports
        # Subtest: should export KeyManager interface
        ok 1 - should export KeyManager interface
          ---
          duration_ms: 17354.093608
          ...
        # Subtest: should export SymphonyKeyManager class
        ok 2 - should export SymphonyKeyManager class
          ---
          duration_ms: 48.878431
          ...
        # Subtest: should export ProductionKeyManager as alias for SymphonyKeyManager
        ok 3 - should export ProductionKeyManager as alias for SymphonyKeyManager
          ---
          duration_ms: 15.665955
          ...
        # Subtest: should export DevelopmentKeyManager class
        ok 4 - should export DevelopmentKeyManager class
          ---
          duration_ms: 1926.115926
          ...
        # Subtest: should export cryptoAudit helper
        ok 5 - should export cryptoAudit helper
          ---
          duration_ms: 82.342355
          ...
        1..5
    ok 1 - Module Exports
      ---
      duration_ms: 19440.366859
      type: 'suite'
      ...
# {"level":30,"time":1768711154652,"system":"symphony","msg":"Configuration guard passed."}
    # Subtest: DevelopmentKeyManager
        # Subtest: should extend SymphonyKeyManager
        ok 1 - should extend SymphonyKeyManager
          ---
          duration_ms: 123.175652
          ...
# {"level":30,"time":1768711154669,"system":"symphony","msg":"DevelopmentKeyManager initialized (dev/prod parity via local-kms)"}
        # Subtest: should have deriveKey method
        ok 2 - should have deriveKey method
          ---
          duration_ms: 19.949235
          ...
        1..2
    ok 2 - DevelopmentKeyManager
      ---
      duration_ms: 148.24306
      type: 'suite'
      ...
# {"level":30,"time":1768711154712,"system":"symphony","msg":"Configuration guard passed."}
# {"level":30,"time":1768711154713,"system":"symphony","msg":"DevelopmentKeyManager initialized (dev/prod parity via local-kms)"}
    # Subtest: SymphonyKeyManager
        # Subtest: should create instance successfully
        ok 1 - should create instance successfully
          ---
          duration_ms: 84.893298
          ...
        # Subtest: should have deriveKey method
        ok 2 - should have deriveKey method
          ---
          duration_ms: 16.208621
          ...
        1..2
    ok 3 - SymphonyKeyManager
      ---
      duration_ms: 101.763205
      type: 'suite'
      ...
    1..3
ok 2 - KeyManager Module
  ---
  duration_ms: 19691.709441
  type: 'suite'
  ...
# {"level":30,"time":1768711147729,"system":"symphony","msg":"Configuration guard passed."}
# {"level":40,"time":1768711147762,"system":"symphony","accountId":"ACC_123","currentBalance":50,"required":100,"msg":"LedgerInvariant: Insufficient funds"}
# Subtest: E. Ledger & Financial Invariants
    # Subtest: E-2 Proof-of-Funds
        # Subtest: should allow transaction if balance >= amount
        ok 1 - should allow transaction if balance >= amount
          ---
          duration_ms: 12.236289
          ...
        # Subtest: should reject transaction if balance < amount
        ok 2 - should reject transaction if balance < amount
          ---
          duration_ms: 13.983745
          ...
        # Subtest: should reject if account not found
        ok 3 - should reject if account not found
          ---
          duration_ms: 1.006871
          ...
        1..3
    ok 1 - E-2 Proof-of-Funds
      ---
      duration_ms: 28.746559
      type: 'suite'
      ...
    # Subtest: E-3 Idempotency
        # Subtest: should allow new transaction ID
        ok 1 - should allow new transaction ID
          ---
          duration_ms: 1.131519
          ...
        # Subtest: should reject duplicate transaction ID
        ok 2 - should reject duplicate transaction ID
          ---
          duration_ms: 0.826748
          ...
        1..2
    ok 2 - E-3 Idempotency
      ---
      duration_ms: 12.93979
      type: 'suite'
      ...
    1..2
ok 3 - E. Ledger & Financial Invariants
  ---
  duration_ms: 12887.90612
  type: 'suite'
  ...
# {"level":50,"time":1768711165773,"system":"symphony","errors":[{"expected":"string","code":"invalid_type","path":["GrpHdr","MsgId"],"message":"Invalid input: expected string, received undefined"}],"type":"pacs.008","msg":"ISO-20022: Schema validation failed"}
# Subtest: D. ISO-20022 Execution Control
    # Subtest: D-1 Structural Validation
        # Subtest: should accept valid pacs.008 message
        ok 1 - should accept valid pacs.008 message
          ---
          duration_ms: 41.891438
          ...
        # Subtest: should reject malformed schema (missing field)
        ok 2 - should reject malformed schema (missing field)
          ---
          duration_ms: 32.775795
          ...
        # Subtest: should accept valid pacs.002 message
        ok 3 - should accept valid pacs.002 message
          ---
          duration_ms: 29.610089
          ...
        1..3
    ok 1 - D-1 Structural Validation
      ---
      duration_ms: 106.499186
      type: 'suite'
      ...
    # Subtest: D-2 Semantic Execution Validation
        # Subtest: should enforce positive amounts (Schema Level)
        ok 1 - should enforce positive amounts (Schema Level)
          ---
          duration_ms: 32.552309
          ...
        # Subtest: should enforce currency consistency
        ok 2 - should enforce currency consistency
          ---
          duration_ms: 1.29862
          ...
        # Subtest: should enforce instruction uniqueness
        ok 3 - should enforce instruction uniqueness
          ---
          duration_ms: 1.128131
          ...
        1..3
    ok 2 - D-2 Semantic Execution Validation
      ---
      duration_ms: 35.875105
      type: 'suite'
      ...
    # Subtest: D-4 Deterministic Mapping
        # Subtest: should map inbound pacs.008 deterministically
        ok 1 - should map inbound pacs.008 deterministically
          ---
          duration_ms: 1.009738
          ...
        # Subtest: should fail outbound mapping if non-deterministic (missing date)
        ok 2 - should fail outbound mapping if non-deterministic (missing date)
          ---
          duration_ms: 0.799251
          ...
        1..2
    ok 3 - D-4 Deterministic Mapping
      ---
      duration_ms: 2.567243
      type: 'suite'
      ...
    1..3
ok 4 - D. ISO-20022 Execution Control
  ---
  duration_ms: 180.524758
  type: 'suite'
  ...
# {"level":50,"time":1768711165787,"system":"symphony","incidentId":"93bbc356-a5ee-4aaf-b7fe-26210e9dff3f","category":"OPS","internalDetails":{"originalError":"[\\n  {\\n    \\"expected\\": \\"string\\",\\n    \\"code\\": \\"invalid_type\\",\\n    \\"path\\": [\\n      \\"GrpHdr\\",\\n      \\"MsgId\\"\\n    ],\\n    \\"message\\": \\"Invalid input: expected string, received undefined\\"\\n  }\\n]","stack":"ZodError: [\\n  {\\n    \\"expected\\": \\"string\\",\\n    \\"code\\": \\"invalid_type\\",\\n    \\"path\\": [\\n      \\"GrpHdr\\",\\n      \\"MsgId\\"\\n    ],\\n    \\"message\\": \\"Invalid input: expected string, received undefined\\"\\n  }\\n]\\n    at Iso20022Validator.validateSchema (file:///home/mwiza/workspaces/Symphony/libs/iso20022/validator.ts:97:55)\\n    at file:///home/mwiza/workspaces/Symphony/tests/phase7-compliance.test.js:46:35\\n    at getActual (node:assert:498:5)\\n    at Function.throws (node:assert:644:24)\\n    at TestContext.<anonymous> (file:///home/mwiza/workspaces/Symphony/tests/phase7-compliance.test.js:45:20)\\n    at Test.runInAsyncScope (node:async_hooks:206:9)\\n    at Test.run (node:internal/test_runner/test:796:25)\\n    at Suite.processPendingSubtests (node:internal/test_runner/test:526:18)\\n    at Test.postRun (node:internal/test_runner/test:889:19)\\n    at Test.run (node:internal/test_runner/test:835:12)","context":"ISO20022:SchemaValidation"},"stack":"Error: An internal system error occurred. Please contact support with ID: ISO20022:SchemaValidation\\n    at Object.sanitize (file:///home/mwiza/workspaces/Symphony/libs/errors/sanitizer.ts:60:16)\\n    at Iso20022Validator.validateSchema (file:///home/mwiza/workspaces/Symphony/libs/iso20022/validator.ts:107:34)\\n    at file:///home/mwiza/workspaces/Symphony/tests/phase7-compliance.test.js:46:35\\n    at getActual (node:assert:498:5)\\n    at Function.throws (node:assert:644:24)\\n    at TestContext.<anonymous> (file:///home/mwiza/workspaces/Symphony/tests/phase7-compliance.test.js:45:20)\\n    at Test.runInAsyncScope (node:async_hooks:206:9)\\n    at Test.run (node:internal/test_runner/test:796:25)\\n    at Suite.processPendingSubtests (node:internal/test_runner/test:526:18)\\n    at Test.postRun (node:internal/test_runner/test:889:19)","msg":"An internal system error occurred. Please contact support with ID: ISO20022:SchemaValidation"}
# {"level":50,"time":1768711165820,"system":"symphony","errors":[{"origin":"number","code":"too_small","minimum":0,"inclusive":false,"path":["CdtTrfTxInf",0,"IntrBkSttlmAmt","Amount"],"message":"Too small: expected number to be >0"}],"type":"pacs.008","msg":"ISO-20022: Schema validation failed"}
# {"level":50,"time":1768711165820,"system":"symphony","incidentId":"09a747e2-d01b-4d81-aa27-6044617e19c8","category":"OPS","internalDetails":{"originalError":"[\\n  {\\n    \\"origin\\": \\"number\\",\\n    \\"code\\": \\"too_small\\",\\n    \\"minimum\\": 0,\\n    \\"inclusive\\": false,\\n    \\"path\\": [\\n      \\"CdtTrfTxInf\\",\\n      0,\\n      \\"IntrBkSttlmAmt\\",\\n      \\"Amount\\"\\n    ],\\n    \\"message\\": \\"Too small: expected number to be >0\\"\\n  }\\n]","stack":"ZodError: [\\n  {\\n    \\"origin\\": \\"number\\",\\n    \\"code\\": \\"too_small\\",\\n    \\"minimum\\": 0,\\n    \\"inclusive\\": false,\\n    \\"path\\": [\\n      \\"CdtTrfTxInf\\",\\n      0,\\n      \\"IntrBkSttlmAmt\\",\\n      \\"Amount\\"\\n    ],\\n    \\"message\\": \\"Too small: expected number to be >0\\"\\n  }\\n]\\n    at Iso20022Validator.validateSchema (file:///home/mwiza/workspaces/Symphony/libs/iso20022/validator.ts:97:55)\\n    at file:///home/mwiza/workspaces/Symphony/tests/phase7-compliance.test.js:70:35\\n    at getActual (node:assert:498:5)\\n    at Function.throws (node:assert:644:24)\\n    at TestContext.<anonymous> (file:///home/mwiza/workspaces/Symphony/tests/phase7-compliance.test.js:69:20)\\n    at Test.runInAsyncScope (node:async_hooks:206:9)\\n    at Test.run (node:internal/test_runner/test:796:25)\\n    at Test.start (node:internal/test_runner/test:702:17)\\n    at node:internal/test_runner/test:1133:71\\n    at node:internal/per_context/primordials:482:82","context":"ISO20022:SchemaValidation"},"stack":"Error: An internal system error occurred. Please contact support with ID: ISO20022:SchemaValidation\\n    at Object.sanitize (file:///home/mwiza/workspaces/Symphony/libs/errors/sanitizer.ts:60:16)\\n    at Iso20022Validator.validateSchema (file:///home/mwiza/workspaces/Symphony/libs/iso20022/validator.ts:107:34)\\n    at file:///home/mwiza/workspaces/Symphony/tests/phase7-compliance.test.js:70:35\\n    at getActual (node:assert:498:5)\\n    at Function.throws (node:assert:644:24)\\n    at TestContext.<anonymous> (file:///home/mwiza/workspaces/Symphony/tests/phase7-compliance.test.js:69:20)\\n    at Test.runInAsyncScope (node:async_hooks:206:9)\\n    at Test.run (node:internal/test_runner/test:796:25)\\n    at Test.start (node:internal/test_runner/test:702:17)\\n    at node:internal/test_runner/test:1133:71","msg":"An internal system error occurred. Please contact support with ID: ISO20022:SchemaValidation"}
# {"level":40,"time":1768711165852,"system":"symphony","msg":"ISO-20022: Semantic failure - Multi-currency batch not supported in Phase 7"}
# {"level":40,"time":1768711165854,"system":"symphony","msg":"ISO-20022: Semantic failure - Duplicate TxIds in batch"}
# {"level":30,"time":1768711164263,"system":"symphony","msg":"Configuration guard passed."}
# Subtest: F. Operational Safety Controls
    # Subtest: F-1 Rate Limiting
        # Subtest: should allow requests within capacity
        ok 1 - should allow requests within capacity
          ---
          duration_ms: 12.627422
          ...
        # Subtest: should reject requests exceeding capacity
        ok 2 - should reject requests exceeding capacity
          ---
          duration_ms: 0.731349
          ...
# {"level":40,"time":1768711164279,"system":"symphony","principalId":"user_2","msg":"OperationalSafety: Rate limit exceeded"}
# {"level":40,"time":1768711164280,"system":"symphony","principalId":"user_3","msg":"OperationalSafety: Rate limit exceeded"}
        # Subtest: should refill tokens over time
        ok 3 - should refill tokens over time
          ---
          duration_ms: 162.864176
          ...
        1..3
    ok 1 - F-1 Rate Limiting
      ---
      duration_ms: 177.717243
      type: 'suite'
      ...
    # Subtest: F-2 Fail-Safe Behavior
        # Subtest: should commit transaction on success
        ok 1 - should commit transaction on success
          ---
          duration_ms: 0.626857
          ...
        1..1
    ok 2 - F-2 Fail-Safe Behavior
      ---
      duration_ms: 1.01163
      type: 'suite'
      ...
    1..2
ok 5 - F. Operational Safety Controls
  ---
  duration_ms: 4387.988442
  type: 'suite'
  ...
# Subtest: verifyAuditChain (Integrity)
    # Subtest: should verify a valid chain
    ok 1 - should verify a valid chain
      ---
      duration_ms: 18.444925
      ...
    # Subtest: should detect tamper (broken chain)
    ok 2 - should detect tamper (broken chain)
      ---
      duration_ms: 10.578098
      ...
    # Subtest: should handle malformed JSON safely (no eval)
    ok 3 - should handle malformed JSON safely (no eval)
      ---
      duration_ms: 5.217453
      ...
    1..3
ok 6 - verifyAuditChain (Integrity)
  ---
  duration_ms: 61.988559
  type: 'suite'
  ...
# Subtest: Authorization Engine Guards
    # Subtest: Guard 1: Emergency Lockdown
        # Subtest: should block all capabilities when EMERGENCY_LOCKDOWN is active
        ok 1 - should block all capabilities when EMERGENCY_LOCKDOWN is active
          ---
          duration_ms: 1.893224
          ...
        1..1
    ok 1 - Guard 1: Emergency Lockdown
      ---
      duration_ms: 3.728993
      type: 'suite'
      ...
    # Subtest: Guard 2: OU Boundary Assertion
        # Subtest: should deny when service attempts capability it does not own
        ok 1 - should deny when service attempts capability it does not own
          ---
          duration_ms: 0.93617
          ...
        # Subtest: should allow when service owns the capability
        ok 2 - should allow when service owns the capability
          ---
          duration_ms: 0.521294
          ...
        1..2
    ok 2 - Guard 2: OU Boundary Assertion
      ---
      duration_ms: 2.246249
      type: 'suite'
      ...
    # Subtest: Guard 3: Client Restriction Invariant
        # Subtest: should block clients from execution-class activities
        ok 1 - should block clients from execution-class activities
          ---
          duration_ms: 13.64816
          ...
        # Subtest: should allow clients for non-restricted activities
        ok 2 - should allow clients for non-restricted activities
          ---
          duration_ms: 0.991427
          ...
        1..2
    ok 3 - Guard 3: Client Restriction Invariant
      ---
      duration_ms: 15.285984
      type: 'suite'
      ...
    # Subtest: Guard 4: Policy Version Parity
        # Subtest: should deny when policy versions mismatch
        ok 1 - should deny when policy versions mismatch
          ---
          duration_ms: 0.826356
          ...
        # Subtest: should allow when policy versions match
        ok 2 - should allow when policy versions match
          ---
          duration_ms: 0.720638
          ...
        1..2
    ok 4 - Guard 4: Policy Version Parity
      ---
      duration_ms: 2.07798
      type: 'suite'
      ...
    1..4
ok 7 - Authorization Engine Guards
  ---
  duration_ms: 38.772074
  type: 'suite'
  ...
# Subtest: IncidentContainment Rules
    # Subtest: Rule 1: SEC-2 + CRITICAL triggers GLOBAL FREEZE
        # Subtest: should trigger global kill switch for integrity breach
        ok 1 - should trigger global kill switch for integrity breach
          ---
          duration_ms: 1.811195
          ...
        # Subtest: should NOT trigger for SEC-2 HIGH
        ok 2 - should NOT trigger for SEC-2 HIGH
          ---
          duration_ms: 0.505908
          ...
        1..2
    ok 1 - Rule 1: SEC-2 + CRITICAL triggers GLOBAL FREEZE
      ---
      duration_ms: 4.026276
      type: 'suite'
      ...
    # Subtest: Rule 2: SEC-1 + CRITICAL triggers SCOPED LOCK
        # Subtest: should trigger actor capability freeze for authz violation
        ok 1 - should trigger actor capability freeze for authz violation
          ---
          duration_ms: 0.775898
          ...
        1..1
    ok 2 - Rule 2: SEC-1 + CRITICAL triggers SCOPED LOCK
      ---
      duration_ms: 1.238739
      type: 'suite'
      ...
    # Subtest: No Action for Non-Critical
        # Subtest: should not trigger any action for non-critical signals
        ok 1 - should not trigger any action for non-critical signals
          ---
          duration_ms: 0.452549
          ...
        1..1
    ok 3 - No Action for Non-Critical
      ---
      duration_ms: 0.856336
      type: 'suite'
      ...
    1..3
ok 8 - IncidentContainment Rules
  ---
  duration_ms: 18.521028
  type: 'suite'
  ...
# Subtest: Database Configuration Guards
    # Subtest: should enforce TLS in production environment
    ok 1 - should enforce TLS in production environment
      ---
      duration_ms: 12116.605501
      ...
    # Subtest: should throw error if DB_CA_CERT is missing in production
    not ok 2 - should throw error if DB_CA_CERT is missing in production
      ---
      duration_ms: 10678.441388
      location: '/home/mwiza/workspaces/Symphony/tests/unit/DatabaseConfig.spec.ts:35:5'
      failureType: 'testCodeFailure'
      error: |-
        The input did not match the regular expression /CRITICAL: Missing DB_CA_CERT in protected environment/. Input:
        
        ''
        
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected:
      actual: ''
      operator: 'match'
      stack: |-
        TestContext.<anonymous> (file:///home/mwiza/workspaces/Symphony/tests/unit/DatabaseConfig.spec.ts:46:16)
        Test.runInAsyncScope (node:async_hooks:206:9)
        Test.run (node:internal/test_runner/test:796:25)
        Suite.processPendingSubtests (node:internal/test_runner/test:526:18)
        Test.postRun (node:internal/test_runner/test:889:19)
        Test.run (node:internal/test_runner/test:835:12)
        async Promise.all (index 0)
        async Suite.run (node:internal/test_runner/test:1135:7)
        async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: should throw error if DB_CA_CERT is missing in staging
    not ok 3 - should throw error if DB_CA_CERT is missing in staging
      ---
      duration_ms: 10097.359712
      location: '/home/mwiza/workspaces/Symphony/tests/unit/DatabaseConfig.spec.ts:48:5'
      failureType: 'testCodeFailure'
      error: |-
        The input did not match the regular expression /CRITICAL: Missing DB_CA_CERT in protected environment/. Input:
        
        ''
        
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected:
      actual: ''
      operator: 'match'
      stack: |-
        TestContext.<anonymous> (file:///home/mwiza/workspaces/Symphony/tests/unit/DatabaseConfig.spec.ts:59:16)
        Test.runInAsyncScope (node:async_hooks:206:9)
        Test.run (node:internal/test_runner/test:796:25)
        Suite.processPendingSubtests (node:internal/test_runner/test:526:18)
        Test.postRun (node:internal/test_runner/test:889:19)
        Test.run (node:internal/test_runner/test:835:12)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: should allow missing DB_CA_CERT in development (default)
    ok 4 - should allow missing DB_CA_CERT in development (default)
      ---
      duration_ms: 11140.374187
      ...
    1..4
not ok 9 - Database Configuration Guards
  ---
  duration_ms: 44047.264074
  type: 'suite'
  location: '/home/mwiza/workspaces/Symphony/tests/unit/DatabaseConfig.spec.ts:4:1'
  failureType: 'subtestsFailed'
  error: '2 subtests failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: Evidence Bundle Schema - Phase-7R Sections
    # Subtest: attestation_gap Section
        # Subtest: should validate complete attestation_gap object
        ok 1 - should validate complete attestation_gap object
          ---
          duration_ms: 11.803887
          ...
        # Subtest: should fail when gap > 0
        ok 2 - should fail when gap > 0
          ---
          duration_ms: 0.521676
          ...
        # Subtest: should require all fields
        ok 3 - should require all fields
          ---
          duration_ms: 1.353481
          ...
        # Subtest: should validate status enum
        ok 4 - should validate status enum
          ---
          duration_ms: 0.357173
          ...
        1..4
    ok 1 - attestation_gap Section
      ---
      duration_ms: 16.319289
      type: 'suite'
      ...
    # Subtest: dlq_metrics Section
        # Subtest: should validate complete dlq_metrics object
        ok 1 - should validate complete dlq_metrics object
          ---
          duration_ms: 0.787258
          ...
        # Subtest: should require all fields
        ok 2 - should require all fields
          ---
          duration_ms: 0.997907
          ...
        # Subtest: should enforce non-negative integers
        ok 3 - should enforce non-negative integers
          ---
          duration_ms: 0.527969
          ...
        1..3
    ok 2 - dlq_metrics Section
      ---
      duration_ms: 4.920017
      type: 'suite'
      ...
    # Subtest: revocation_bounds Section
        # Subtest: should validate complete revocation_bounds object
        ok 1 - should validate complete revocation_bounds object
          ---
          duration_ms: 17.63891
          ...
        # Subtest: should enforce cert_ttl_hours <= 24
        ok 2 - should enforce cert_ttl_hours <= 24
          ---
          duration_ms: 0.48512
          ...
        # Subtest: should correctly calculate worst_case
        ok 3 - should correctly calculate worst_case
          ---
          duration_ms: 0.556834
          ...
        # Subtest: should require ttl and propagation fields
        ok 4 - should require ttl and propagation fields
          ---
          duration_ms: 0.646327
          ...
        1..4
    ok 3 - revocation_bounds Section
      ---
      duration_ms: 20.169685
      type: 'suite'
      ...
    # Subtest: idempotency_metrics Section
        # Subtest: should validate complete idempotency_metrics object
        ok 1 - should validate complete idempotency_metrics object
          ---
          duration_ms: 0.556035
          ...
        # Subtest: should require terminal_reentry_attempts = 0 for healthy system
        ok 2 - should require terminal_reentry_attempts = 0 for healthy system
          ---
          duration_ms: 0.393829
          ...
        # Subtest: should require core fields
        ok 3 - should require core fields
          ---
          duration_ms: 0.420197
          ...
        # Subtest: should allow optional zombie_repairs field
        ok 4 - should allow optional zombie_repairs field
          ---
          duration_ms: 0.253897
          ...
        1..4
    ok 4 - idempotency_metrics Section
      ---
      duration_ms: 2.162015
      type: 'suite'
      ...
    # Subtest: evidence_export Section
        # Subtest: should validate complete evidence_export object
        ok 1 - should validate complete evidence_export object
          ---
          duration_ms: 0.483323
          ...
        # Subtest: should validate status enum
        ok 2 - should validate status enum
          ---
          duration_ms: 0.322115
          ...
        # Subtest: should validate export_target enum
        ok 3 - should validate export_target enum
          ---
          duration_ms: 2.673004
          ...
        # Subtest: should allow null for optional date fields
        ok 4 - should allow null for optional date fields
          ---
          duration_ms: 0.456054
          ...
        # Subtest: should require enabled and status fields
        ok 5 - should require enabled and status fields
          ---
          duration_ms: 0.467142
          ...
        1..5
    ok 5 - evidence_export Section
      ---
      duration_ms: 5.055456
      type: 'suite'
      ...
    1..5
ok 10 - Evidence Bundle Schema - Phase-7R Sections
  ---
  duration_ms: 58.785316
  type: 'suite'
  ...
# {"level":30,"time":1768711188561,"pid":31962,"hostname":"DESKTOP-VV0116A","name":"EvidenceExportService","filepath":"/tmp/test_evidence/batch_mkj8z3gu_a3614253.json","hashFilepath":"/tmp/test_evidence/batch_mkj8z3gu_a3614253.json.sha256","msg":"Batch written to filesystem"}
# Subtest: EvidenceExportService
    # Subtest: getHighWaterMarks
        # Subtest: should fetch marks from DB using coalesced max IDs
        ok 1 - should fetch marks from DB using coalesced max IDs
          ---
          duration_ms: 7.854179
          ...
        1..1
    ok 1 - getHighWaterMarks
      ---
      duration_ms: 17.872851
      type: 'suite'
      ...
    # Subtest: getLastExportState
        # Subtest: should return null if no logs exist
        ok 1 - should return null if no logs exist
          ---
          duration_ms: 13.769862
          ...
        # Subtest: should return last batch state if exists
        ok 2 - should return last batch state if exists
          ---
          duration_ms: 1.657295
          ...
        1..2
    ok 2 - getLastExportState
      ---
      duration_ms: 16.071756
      type: 'suite'
      ...
    # Subtest: exportBatch
        # Subtest: should orchestrate full export flow (fetch -> hash -> write -> log)
        ok 1 - should orchestrate full export flow (fetch -> hash -> write -> log)
          ---
          duration_ms: 34.589204
          ...
        # Subtest: should link to previous batch ID when fromMarks provided
        ok 2 - should link to previous batch ID when fromMarks provided
          ---
          duration_ms: 2.250494
          ...
        # Subtest: should rollback and throw on error
        ok 3 - should rollback and throw on error
          ---
          duration_ms: 30.616215
          ...
        1..3
    ok 3 - exportBatch
      ---
      duration_ms: 68.381611
      type: 'suite'
      ...
    # Subtest: Hashing Logic (Deterministic)
        # Subtest: should produce consistent hash for same data
        ok 1 - should produce consistent hash for same data
          ---
          duration_ms: 103.666313
          ...
        1..1
    ok 4 - Hashing Logic (Deterministic)
      ---
      duration_ms: 103.987612
      type: 'suite'
      ...
    1..4
ok 11 - EvidenceExportService
  ---
  duration_ms: 208.207624
  type: 'suite'
  ...
# {"level":30,"time":1768711188590,"pid":31962,"hostname":"DESKTOP-VV0116A","name":"EvidenceExportService","batchId":"batch_mkj8z3gu_a3614253","recordCounts":{"ingress":1,"outbox":0,"ledger":0},"batchHash":"a514ccf5d21914cecf3a39c733b00f88da5f68c7c4098aa8c0387e3cd84ce789","msg":"Evidence batch exported successfully"}
# {"level":30,"time":1768711188593,"pid":31962,"hostname":"DESKTOP-VV0116A","name":"EvidenceExportService","filepath":"/tmp/test_evidence/batch_mkj8z3hs_0f42007f.json","hashFilepath":"/tmp/test_evidence/batch_mkj8z3hs_0f42007f.json.sha256","msg":"Batch written to filesystem"}
# {"level":30,"time":1768711188593,"pid":31962,"hostname":"DESKTOP-VV0116A","name":"EvidenceExportService","batchId":"batch_mkj8z3hs_0f42007f","recordCounts":{"ingress":0,"outbox":0,"ledger":0},"batchHash":"b69e30fd4a3a4d5a1fce2b9190b657874ae8e571a9376e0df5c29cee5436253c","msg":"Evidence batch exported successfully"}
# {"level":50,"time":1768711188622,"pid":31962,"hostname":"DESKTOP-VV0116A","name":"EvidenceExportService","error":{},"batchId":"batch_mkj8z3hu_dea5ccfe","msg":"Evidence batch export failed"}
# {"level":30,"time":1768711188728,"pid":31962,"hostname":"DESKTOP-VV0116A","name":"EvidenceExportService","filepath":"/tmp/test_evidence/batch_mkj8z3jh_04078225.json","hashFilepath":"/tmp/test_evidence/batch_mkj8z3jh_04078225.json.sha256","msg":"Batch written to filesystem"}
# {"level":30,"time":1768711188728,"pid":31962,"hostname":"DESKTOP-VV0116A","name":"EvidenceExportService","batchId":"batch_mkj8z3jh_04078225","recordCounts":{"ingress":2,"outbox":0,"ledger":0},"batchHash":"fcdd6f39e39921f3e9344fbd1ba6e43c0339b4c4961ebb35e1bc46ba57ad480d","msg":"Evidence batch exported successfully"}
# {"level":30,"time":1768711196591,"system":"symphony","msg":"BC/DR: Commencing Health Verification..."}
# Subtest: HealthVerifier
    # Subtest: should detect missing audit file
    ok 1 - should detect missing audit file
      ---
      duration_ms: 9.542331
      ...
    1..1
ok 12 - HealthVerifier
  ---
  duration_ms: 1127.956272
  type: 'suite'
  ...
# {"level":30,"time":1768711196598,"system":"symphony","msg":"BC/DR: Policy parity verified."}
# {"level":30,"time":1768711196599,"system":"symphony","msg":"BC/DR: Guardrail reconciliation complete."}
# Subtest: Identity Schema Validation (Strict)
    # Subtest: should ACCEPT a valid user envelope with trustTier: "user"
    ok 1 - should ACCEPT a valid user envelope with trustTier: "user"
      ---
      duration_ms: 59.824571
      ...
    # Subtest: should REJECT a user envelope with trustTier: "external"
    ok 2 - should REJECT a user envelope with trustTier: "external"
      ---
      duration_ms: 12.30842
      ...
    # Subtest: should REJECT a service envelope without certFingerprint
    ok 3 - should REJECT a service envelope without certFingerprint
      ---
      duration_ms: 68.039779
      ...
    1..3
ok 13 - Identity Schema Validation (Strict)
  ---
  duration_ms: 151.570411
  type: 'suite'
  ...
# DEBUG: IngressAttestationMiddleware.spec.ts loaded
# DEBUG: beforeEach started
# DEBUG: service instantiated
# DEBUG: test1 started
# DEBUG: attest called
# {"level":30,"time":1768711206130,"pid":32062,"hostname":"DESKTOP-VV0116A","name":"IngressAttestation","event":"INGRESS_ATTESTED","attestationId":"att-1","requestId":"req-1","recordHash":"new-hash-456..."}
# DEBUG: test1 finished
# DEBUG: beforeEach started
# DEBUG: service instantiated
# DEBUG: test2 started
# DEBUG: test2 finished
# DEBUG: beforeEach started
# DEBUG: service instantiated
# DEBUG: test3 started
# DEBUG: test3 finished
# DEBUG: beforeEach started
# DEBUG: service instantiated
# DEBUG: test4 started
# DEBUG: test4 finished
# DEBUG: beforeEach started
# DEBUG: service instantiated
# DEBUG: test5 started
# DEBUG: test5 finished
# Subtest: IngressAttestationService
    # Subtest: attest()
        # Subtest: should validate and insert attestation record
        ok 1 - should validate and insert attestation record
          ---
          duration_ms: 46.2369
          ...
        # Subtest: should throw InvalidEnvelopeError for missing fields
        ok 2 - should throw InvalidEnvelopeError for missing fields
          ---
          duration_ms: 8.987678
          ...
        # Subtest: should release client on error
        ok 3 - should release client on error
          ---
          duration_ms: 5.930706
          ...
        1..3
    ok 1 - attest()
      ---
      duration_ms: 63.465871
      type: 'suite'
      ...
    # Subtest: markExecutionStarted()
        # Subtest: should update execution_started with attestedAt pruning
        ok 1 - should update execution_started with attestedAt pruning
          ---
          duration_ms: 2.527791
          ...
        1..1
    ok 2 - markExecutionStarted()
      ---
      duration_ms: 2.940457
      type: 'suite'
      ...
    # Subtest: markExecutionCompleted()
        # Subtest: should update execution_completed with attestedAt pruning
        ok 1 - should update execution_completed with attestedAt pruning
          ---
          duration_ms: 6.371724
          ...
        1..1
    ok 3 - markExecutionCompleted()
      ---
      duration_ms: 7.191946
      type: 'suite'
      ...
    1..3
ok 14 - IngressAttestationService
  ---
  duration_ms: 92.140683
  type: 'suite'
  ...
# {"level":50,"time":1768711206176,"pid":32062,"hostname":"DESKTOP-VV0116A","name":"IngressAttestation","error":"DB Error","msg":"Attestation failed"}
# Subtest: InstructionStateClient
    # Subtest: State Machine Validation
        # Subtest: should identify COMPLETED as terminal
        ok 1 - should identify COMPLETED as terminal
          ---
          duration_ms: 8.611721
          ...
        # Subtest: should identify FAILED as terminal
        ok 2 - should identify FAILED as terminal
          ---
          duration_ms: 0.469398
          ...
        # Subtest: should identify EXECUTING as non-terminal
        ok 3 - should identify EXECUTING as non-terminal
          ---
          duration_ms: 2.589104
          ...
        # Subtest: should have exactly 2 terminal states
        ok 4 - should have exactly 2 terminal states
          ---
          duration_ms: 0.488804
          ...
        1..4
    ok 1 - State Machine Validation
      ---
      duration_ms: 13.81523
      type: 'suite'
      ...
    # Subtest: API Integration Contract
        # Subtest: should use correct state query endpoint format
        ok 1 - should use correct state query endpoint format
          ---
          duration_ms: 0.496119
          ...
        # Subtest: should use correct transition endpoint format
        ok 2 - should use correct transition endpoint format
          ---
          duration_ms: 0.378566
          ...
        1..2
    ok 2 - API Integration Contract
      ---
      duration_ms: 1.648074
      type: 'suite'
      ...
    # Subtest: Transition Request Validation
        # Subtest: should only allow COMPLETED or FAILED as target states
        ok 1 - should only allow COMPLETED or FAILED as target states
          ---
          duration_ms: 0.596907
          ...
        1..1
    ok 3 - Transition Request Validation
      ---
      duration_ms: 0.965111
      type: 'suite'
      ...
    1..3
ok 15 - InstructionStateClient
  ---
  duration_ms: 42.842199
  type: 'suite'
  ...
# {"level":30,"time":1768711216626,"system":"symphony","keyCount":1,"msg":"JWKS loaded successfully"}
# Subtest: JWKS Loader (Security Hardened)
    # Subtest: should load JWKS from default path if exists
    ok 1 - should load JWKS from default path if exists
      ---
      duration_ms: 5.20357
      ...
    # Subtest: should FAIL CLOSED in PRODUCTION if JWKS missing
    ok 2 - should FAIL CLOSED in PRODUCTION if JWKS missing
      ---
      duration_ms: 1.413951
      ...
    # Subtest: should use fallback in DEVELOPMENT if JWKS missing
    ok 3 - should use fallback in DEVELOPMENT if JWKS missing
      ---
      duration_ms: 11.729312
      ...
    # Subtest: should REJECT path traversal via JWKS_PATH
    ok 4 - should REJECT path traversal via JWKS_PATH
      ---
      duration_ms: 0.86186
      ...
    # Subtest: should refresh cache after TTL
    ok 5 - should refresh cache after TTL
      ---
      duration_ms: 1.904654
      ...
    1..5
ok 16 - JWKS Loader (Security Hardened)
  ---
  duration_ms: 26.001899
  type: 'suite'
  ...
# {"level":40,"time":1768711216632,"system":"symphony","path":"/home/mwiza/workspaces/Symphony/non-existent-jwks.json","msg":"JWKS file not found - using development fallback"}
# {"level":30,"time":1768711216645,"system":"symphony","keyCount":1,"msg":"JWKS loaded successfully"}
# {"level":30,"time":1768711216646,"system":"symphony","keyCount":1,"msg":"JWKS loaded successfully"}
# {"level":30,"time":1768711227802,"system":"symphony","keyCount":1,"msg":"JWKS loaded successfully"}
# {"level":30,"time":1768711227843,"system":"symphony","type":"IDENTITY_BRIDGE","requestId":"3ae1e51b-f27e-4f68-9f61-179e8e06aef0","action":"TERMINATE_JWT_AND_BRIDGE_CLIENT","subjectId":"user-1","trustTier":"external","msg":"Bridged external client identity"}
# Subtest: jwtToMtlsBridge
    # Subtest: should bridge valid CLIENT JWT
    ok 1 - should bridge valid CLIENT JWT
      ---
      duration_ms: 95.839577
      ...
# {"level":30,"time":1768711227945,"system":"symphony","type":"IDENTITY_BRIDGE","requestId":"34737f87-cadf-43ee-bdf4-0cee6ae1e042","action":"TERMINATE_JWT_AND_BRIDGE_USER","subjectId":"user-alice","participantId":"tenant-A","trustTier":"user","msg":"Bridged tenant-anchored user identity"}
    # Subtest: should bridge valid TENANT-ANCHORED USER JWT
    ok 2 - should bridge valid TENANT-ANCHORED USER JWT
      ---
      duration_ms: 100.429275
      ...
    # Subtest: should reject invalid signature
    ok 3 - should reject invalid signature
      ---
      duration_ms: 33.250843
      ...
# {"level":40,"time":1768711227978,"system":"symphony","error":"signature verification failed","msg":"JWT verification failed"}
# {"level":40,"time":1768711227998,"system":"symphony","error":"\\"exp\\" claim timestamp check failed","msg":"JWT verification failed"}
    # Subtest: should reject expired token
    ok 4 - should reject expired token
      ---
      duration_ms: 52.306988
      ...
# {"level":40,"time":1768711228080,"system":"symphony","error":"unexpected \\"aud\\" claim value","msg":"JWT verification failed"}
    # Subtest: should reject wrong audience
    ok 5 - should reject wrong audience
      ---
      duration_ms: 47.937418
      ...
    1..5
ok 17 - jwtToMtlsBridge
  ---
  duration_ms: 363.356464
  type: 'suite'
  ...
# Subtest: SymphonyKeyManager (SEC-FIX)
    # Subtest: KMS_KEY_REF Enforcement
        # Subtest: should throw if KMS_KEY_REF is missing
        ok 1 - should throw if KMS_KEY_REF is missing
          ---
          duration_ms: 2491.189128
          ...
        # Subtest: should throw if KMS_KEY_REF is empty string
        ok 2 - should throw if KMS_KEY_REF is empty string
          ---
          duration_ms: 21.541421
          ...
        # Subtest: should NOT use alias/symphony-root fallback
        ok 3 - should NOT use alias/symphony-root fallback
          ---
          duration_ms: 16.935151
          ...
# {"level":50,"time":1768711234375,"system":"symphony","error":"Region is missing","operation":"deriveKey","keyRef":"arn:aws:kms:us-east-...","msg":"KMS key derivation failed"}
        # Subtest: should use KMS_KEY_REF when present
        ok 4 - should use KMS_KEY_REF when present
          ---
          duration_ms: 48.636262
          ...
        1..4
    ok 1 - KMS_KEY_REF Enforcement
      ---
      duration_ms: 2580.644031
      type: 'suite'
      ...
    # Subtest: Logging Correctness
        # Subtest: should log operation as deriveKey (not decrypt)
        ok 1 - should log operation as deriveKey (not decrypt)
          ---
          duration_ms: 6.274085
          ...
        1..1
    ok 2 - Logging Correctness
      ---
      duration_ms: 6.641067
      type: 'suite'
      ...
    1..2
ok 18 - SymphonyKeyManager (SEC-FIX)
  ---
  duration_ms: 2588.633714
  type: 'suite'
  ...
# Subtest: LedgerReplayEngine
    # Subtest: Balance Reconstruction
        # Subtest: should correctly sum debits and credits per account
        ok 1 - should correctly sum debits and credits per account
          ---
          duration_ms: 3.532723
          ...
        # Subtest: should calculate correct net balance
        ok 2 - should calculate correct net balance
          ---
          duration_ms: 0.524874
          ...
        # Subtest: should handle empty ledger
        ok 3 - should handle empty ledger
          ---
          duration_ms: 0.38338
          ...
        # Subtest: should handle multiple currencies for same account
        ok 4 - should handle multiple currencies for same account
          ---
          duration_ms: 3.372331
          ...
        1..4
    ok 1 - Balance Reconstruction
      ---
      duration_ms: 10.309983
      type: 'suite'
      ...
    # Subtest: Deterministic Hashing
        # Subtest: should produce consistent hash for same input data
        ok 1 - should produce consistent hash for same input data
          ---
          duration_ms: 1.79991
          ...
        # Subtest: should produce different hash for different input data
        ok 2 - should produce different hash for different input data
          ---
          duration_ms: 1.464427
          ...
        1..2
    ok 2 - Deterministic Hashing
      ---
      duration_ms: 5.40123
      type: 'suite'
      ...
    # Subtest: Replay Reproducibility
        # Subtest: should produce identical results on repeated runs with same input
        ok 1 - should produce identical results on repeated runs with same input
          ---
          duration_ms: 2.244187
          ...
        1..1
    ok 3 - Replay Reproducibility
      ---
      duration_ms: 2.994749
      type: 'suite'
      ...
    1..3
ok 19 - LedgerReplayEngine
  ---
  duration_ms: 20.74496
  type: 'suite'
  ...
# Subtest: ReplayVerificationReport
    # Subtest: Balance Comparison
        # Subtest: should detect matching balances
        ok 1 - should detect matching balances
          ---
          duration_ms: 0.458277
          ...
        # Subtest: should detect deviations
        ok 2 - should detect deviations
          ---
          duration_ms: 0.528773
          ...
        # Subtest: should tolerate rounding within 1 cent
        ok 3 - should tolerate rounding within 1 cent
          ---
          duration_ms: 0.372082
          ...
        1..3
    ok 1 - Balance Comparison
      ---
      duration_ms: 1.781111
      type: 'suite'
      ...
    # Subtest: Report Status
        # Subtest: should return PASS when all balances match
        ok 1 - should return PASS when all balances match
          ---
          duration_ms: 0.402279
          ...
        # Subtest: should return WARNING for 1-3 deviations
        ok 2 - should return WARNING for 1-3 deviations
          ---
          duration_ms: 0.428078
          ...
        # Subtest: should return FAIL for >3 deviations
        ok 3 - should return FAIL for >3 deviations
          ---
          duration_ms: 4.436078
          ...
        1..3
    ok 2 - Report Status
      ---
      duration_ms: 6.286085
      type: 'suite'
      ...
    # Subtest: Report Hashing
        # Subtest: should include hash of input datasets
        ok 1 - should include hash of input datasets
          ---
          duration_ms: 0.671566
          ...
        # Subtest: should include hash of final report
        ok 2 - should include hash of final report
          ---
          duration_ms: 0.420179
          ...
        1..2
    ok 3 - Report Hashing
      ---
      duration_ms: 1.421229
      type: 'suite'
      ...
    1..3
ok 20 - ReplayVerificationReport
  ---
  duration_ms: 10.248786
  type: 'suite'
  ...
# Subtest: MonotonicIdGenerator
    # Subtest: ID Generation
        # Subtest: should generate unique IDs
        ok 1 - should generate unique IDs
          ---
          duration_ms: 11.401561
          ...
        # Subtest: should generate monotonically increasing IDs
        ok 2 - should generate monotonically increasing IDs
          ---
          duration_ms: 13.281104
          ...
        # Subtest: should generate IDs as strings
        ok 3 - should generate IDs as strings
          ---
          duration_ms: 3.511695
          ...
        1..3
    ok 1 - ID Generation
      ---
      duration_ms: 30.161402
      type: 'suite'
      ...
    # Subtest: Worker ID Validation
        # Subtest: should accept valid worker IDs (0-1023)
        ok 1 - should accept valid worker IDs (0-1023)
          ---
          duration_ms: 1.164866
          ...
        # Subtest: should reject invalid worker IDs
        ok 2 - should reject invalid worker IDs
          ---
          duration_ms: 1.330661
          ...
        1..2
    ok 2 - Worker ID Validation
      ---
      duration_ms: 3.182605
      type: 'suite'
      ...
    # Subtest: Clock-Safety: Wait State
        # Subtest: should not be in wait state initially
        ok 1 - should not be in wait state initially
          ---
          duration_ms: 0.99317
          ...
        # Subtest: should handle sequence overflow within same millisecond
        ok 2 - should handle sequence overflow within same millisecond
          ---
          duration_ms: 2.499726
          ...
        1..2
    ok 3 - Clock-Safety: Wait State
      ---
      duration_ms: 4.563964
      type: 'suite'
      ...
    # Subtest: Factory Function
        # Subtest: should create generator with specified worker ID
        ok 1 - should create generator with specified worker ID
          ---
          duration_ms: 0.639081
          ...
        1..1
    ok 4 - Factory Function
      ---
      duration_ms: 1.093768
      type: 'suite'
      ...
    1..4
ok 21 - MonotonicIdGenerator
  ---
  duration_ms: 68.817151
  type: 'suite'
  ...
# Subtest: ClockMovedBackwardsError
    # Subtest: should have correct error properties
    ok 1 - should have correct error properties
      ---
      duration_ms: 0.630781
      ...
    1..1
ok 22 - ClockMovedBackwardsError
  ---
  duration_ms: 1.077367
  type: 'suite'
  ...
# Subtest: MtlsGate
    # Subtest: getServerOptions
        # Subtest: should return hardened server options with rejectUnauthorized=true
        ok 1 - should return hardened server options with rejectUnauthorized=true
          ---
          duration_ms: 1.600776
          ...
        # Subtest: should read from environment variables
        ok 2 - should read from environment variables
          ---
          duration_ms: 0.457993
          ...
        1..2
    ok 1 - getServerOptions
      ---
      duration_ms: 12.75961
      type: 'suite'
      ...
    # Subtest: getAgent
        # Subtest: should return HTTPS agent with rejectUnauthorized=true
        ok 1 - should return HTTPS agent with rejectUnauthorized=true
          ---
          duration_ms: 0.958986
          ...
        1..1
    ok 2 - getAgent
      ---
      duration_ms: 1.261881
      type: 'suite'
      ...
    1..2
ok 23 - MtlsGate
  ---
  duration_ms: 219.827344
  type: 'suite'
  ...
# {"level":30,"time":1768711246553,"pid":32258,"hostname":"DESKTOP-VV0116A","name":"OutboxDispatch","event":"DISPATCH_QUEUED","outboxId":"outbox-1","sequenceId":"1234567890","participantId":"part-1","eventType":"PAYMENT"}
# Subtest: OutboxDispatchService
    # Subtest: atomic dispatch
        # Subtest: should dispatch to outbox and ledger in same transaction
        not ok 1 - should dispatch to outbox and ledger in same transaction
          ---
          duration_ms: 52.644875
          location: '/home/mwiza/workspaces/Symphony/tests/unit/OutboxDispatchService.spec.ts:34:9'
          failureType: 'testCodeFailure'
          error: "Cannot read properties of undefined (reading 'arguments')"
          code: 'ERR_TEST_FAILURE'
          name: 'TypeError'
          stack: |-
            TestContext.<anonymous> (file:///home/mwiza/workspaces/Symphony/tests/unit/OutboxDispatchService.spec.ts:70:40)
            async Test.run (node:internal/test_runner/test:797:9)
            async Promise.all (index 0)
            async Suite.run (node:internal/test_runner/test:1135:7)
            async Promise.all (index 0)
            async Suite.run (node:internal/test_runner/test:1135:7)
            async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: should rollback on error
        not ok 2 - should rollback on error
          ---
          duration_ms: 96.276241
          location: '/home/mwiza/workspaces/Symphony/tests/unit/OutboxDispatchService.spec.ts:78:9'
          failureType: 'testCodeFailure'
          error: |-
            Expected values to be strictly equal:
            + actual - expected
            
            + 'ROLLBACK'
            - 'COMMIT'
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: 'COMMIT'
          actual: 'ROLLBACK'
          operator: 'strictEqual'
          stack: |-
            TestContext.<anonymous> (file:///home/mwiza/workspaces/Symphony/tests/unit/OutboxDispatchService.spec.ts:94:20)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        1..2
    not ok 1 - atomic dispatch
      ---
      duration_ms: 176.778838
      type: 'suite'
      location: '/home/mwiza/workspaces/Symphony/tests/unit/OutboxDispatchService.spec.ts:32:5'
      failureType: 'subtestsFailed'
      error: '2 subtests failed'
      code: 'ERR_TEST_FAILURE'
      stack: |-
        async Promise.all (index 0)
      ...
    # Subtest: idempotency
        # Subtest: should return existing record on duplicate idempotency key
        ok 1 - should return existing record on duplicate idempotency key
          ---
          duration_ms: 2.484975
          ...
        # Subtest: should handle concurrent insert race condition
        ok 2 - should handle concurrent insert race condition
          ---
          duration_ms: 24.06756
          ...
        1..2
    ok 2 - idempotency
      ---
      duration_ms: 27.596025
      type: 'suite'
      ...
    1..2
not ok 24 - OutboxDispatchService
  ---
  duration_ms: 206.894039
  type: 'suite'
  location: '/home/mwiza/workspaces/Symphony/tests/unit/OutboxDispatchService.spec.ts:12:1'
  failureType: 'subtestsFailed'
  error: '1 subtest failed'
  code: 'ERR_TEST_FAILURE'
  ...
# {"level":30,"time":1768711246565,"pid":32258,"hostname":"DESKTOP-VV0116A","name":"OutboxDispatch","event":"LEDGER_AND_DISPATCH_COMMITTED","outboxId":"outbox-1","ledgerEntries":1}
# {"level":50,"time":1768711246585,"pid":32258,"hostname":"DESKTOP-VV0116A","name":"OutboxDispatch","error":"DB Error","msg":"Dispatch failed"}
# {"level":30,"time":1768711246694,"pid":32258,"hostname":"DESKTOP-VV0116A","name":"OutboxDispatch","event":"DUPLICATE_DISPATCH","idempotencyKey":"idem-1","existingId":"existing-1","existingStatus":"PENDING"}
# {"level":30,"time":1768711250594,"pid":32281,"hostname":"DESKTOP-VV0116A","name":"OutboxRelayer","correlationId":"uuid-1","railReference":"ref-123","msg":"Dispatch successful"}
# Subtest: OutboxRelayer
    # Subtest: poll() -> fetchNextBatch()
        # Subtest: should process available records
        ok 1 - should process available records
          ---
          duration_ms: 4.151675
          ...
        1..1
    ok 1 - poll() -> fetchNextBatch()
      ---
      duration_ms: 5.868011
      type: 'suite'
      ...
    # Subtest: processRecord()
        # Subtest: should dispatch to rail and mark success
        ok 1 - should dispatch to rail and mark success
          ---
          duration_ms: 8.463395
          ...
        # Subtest: should handle transient errors by marking RECOVERING
        ok 2 - should handle transient errors by marking RECOVERING
          ---
          duration_ms: 13.530883
          ...
        # Subtest: should dlq after max retries
        ok 3 - should dlq after max retries
          ---
          duration_ms: 2.166
          ...
        1..3
    ok 2 - processRecord()
      ---
      duration_ms: 26.944079
      type: 'suite'
      ...
    1..2
ok 25 - OutboxRelayer
  ---
  duration_ms: 41.770106
  type: 'suite'
  ...
# {"level":50,"time":1768711250614,"pid":32281,"hostname":"DESKTOP-VV0116A","name":"OutboxRelayer","correlationId":"uuid-1","error":"ECONNRESET: Connection reset","msg":"Dispatch failure"}
# {"level":40,"time":1768711250616,"pid":32281,"hostname":"DESKTOP-VV0116A","name":"OutboxRelayer","correlationId":"uuid-1","retryCount":5,"msg":"Moved to DLQ"}
# {"level":30,"time":1768711255647,"system":"symphony","msg":"Configuration guard passed."}
# Subtest: validatePolicyVersion
    # Subtest: should accept matching policy version
    ok 1 - should accept matching policy version
      ---
      duration_ms: 62.82811
      ...
    # Subtest: should reject mismatched policy version
    ok 2 - should reject mismatched policy version
      ---
      duration_ms: 2.426192
      ...
    # Subtest: should reject invalid policy version format
    ok 3 - should reject invalid policy version format
      ---
      duration_ms: 0.969497
      ...
    1..3
ok 26 - validatePolicyVersion
  ---
  duration_ms: 2416.918717
  type: 'suite'
  ...
# {"level":30,"time":1768711258238,"pid":32328,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_STATE_REFRESHED","activeVersion":"v1.2.3","acceptedCount":2,"graceCount":1}
# Subtest: PolicyConsistencyService
    # Subtest: getGlobalPolicyState
        # Subtest: should load and cache policy state from database
        ok 1 - should load and cache policy state from database
          ---
          duration_ms: 13.54428
          ...
        1..1
    ok 1 - getGlobalPolicyState
      ---
      duration_ms: 14.940987
      type: 'suite'
      ...
    # Subtest: validatePolicyClaims
        # Subtest: should validate a valid token with active version
        ok 1 - should validate a valid token with active version
          ---
          duration_ms: 13.484365
          ...
        # Subtest: should allow token in grace period but flag for re-auth
        ok 2 - should allow token in grace period but flag for re-auth
          ---
          duration_ms: 1.594026
          ...
        # Subtest: should reject retired or unknown versions
        ok 3 - should reject retired or unknown versions
          ---
          duration_ms: 6.232509
          ...
        # Subtest: should reject tokens with invalid scope
        ok 4 - should reject tokens with invalid scope
          ---
          duration_ms: 7.455465
          ...
        # Subtest: should reject expired tokens
        ok 5 - should reject expired tokens
          ---
          duration_ms: 1.985867
          ...
        1..5
    ok 2 - validatePolicyClaims
      ---
      duration_ms: 32.144347
      type: 'suite'
      ...
    # Subtest: isOperationAllowed
        # Subtest: should allow authorized operations within limits
        ok 1 - should allow authorized operations within limits
          ---
          duration_ms: 2.519806
          ...
        # Subtest: should deny unauthorized operations
        ok 2 - should deny unauthorized operations
          ---
          duration_ms: 1.169232
          ...
        # Subtest: should deny transaction amounts exceeding limit
        ok 3 - should deny transaction amounts exceeding limit
          ---
          duration_ms: 2.234812
          ...
        1..3
    ok 3 - isOperationAllowed
      ---
      duration_ms: 6.604479
      type: 'suite'
      ...
    1..3
ok 27 - PolicyConsistencyService
  ---
  duration_ms: 55.245794
  type: 'suite'
  ...
# {"level":30,"time":1768711258247,"pid":32328,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_CACHE_INVALIDATED"}
# {"level":30,"time":1768711258255,"pid":32328,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_STATE_REFRESHED","activeVersion":"v1.2.3","acceptedCount":2,"graceCount":1}
# {"level":30,"time":1768711258263,"pid":32328,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_CACHE_INVALIDATED"}
# {"level":30,"time":1768711258264,"pid":32328,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_STATE_REFRESHED","activeVersion":"v1.2.3","acceptedCount":2,"graceCount":1}
# {"level":30,"time":1768711258264,"pid":32328,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_VERSION_IN_GRACE","tokenVersion":"v1.2.2","activeVersion":"v1.2.3","participantId":"user-123"}
# {"level":30,"time":1768711258264,"pid":32328,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_CACHE_INVALIDATED"}
# {"level":30,"time":1768711258266,"pid":32328,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_STATE_REFRESHED","activeVersion":"v1.2.3","acceptedCount":2,"graceCount":1}
# {"level":40,"time":1768711258267,"pid":32328,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_VERSION_REJECTED","tokenVersion":"v1.0.0","activeVersion":"v1.2.3","tokenHash":"2485f4d55aae6c5b","activeHash":"e3cad1a6f905017f","participantId":"user-123","acceptedVersions":["v1.2.3","v1.2.2"]}
# {"level":30,"time":1768711258270,"pid":32328,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_CACHE_INVALIDATED"}
# {"level":30,"time":1768711258272,"pid":32328,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_STATE_REFRESHED","activeVersion":"v1.2.3","acceptedCount":2,"graceCount":1}
# {"level":30,"time":1768711258279,"pid":32328,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_CACHE_INVALIDATED"}
# {"level":30,"time":1768711258281,"pid":32328,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_STATE_REFRESHED","activeVersion":"v1.2.3","acceptedCount":2,"graceCount":1}
# {"level":30,"time":1768711258281,"pid":32328,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_CACHE_INVALIDATED"}
# {"level":30,"time":1768711258283,"pid":32328,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_STATE_REFRESHED","activeVersion":"v1.2.3","acceptedCount":2,"graceCount":1}
# {"level":30,"time":1768711258283,"pid":32328,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_CACHE_INVALIDATED"}
# {"level":30,"time":1768711258285,"pid":32328,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_STATE_REFRESHED","activeVersion":"v1.2.3","acceptedCount":2,"graceCount":1}
# {"level":40,"time":1768711258285,"pid":32328,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"OPERATION_NOT_ALLOWED","operation":"REFUND","participantId":"user-123","scope":"TIER_1"}
# {"level":30,"time":1768711258285,"pid":32328,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_CACHE_INVALIDATED"}
# {"level":30,"time":1768711258287,"pid":32328,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_STATE_REFRESHED","activeVersion":"v1.2.3","acceptedCount":2,"graceCount":1}
# {"level":40,"time":1768711258287,"pid":32328,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"AMOUNT_EXCEEDS_LIMIT","amount":1500,"limit":1000,"participantId":"user-123"}
# {"level":30,"time":1768711258288,"pid":32328,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_CACHE_INVALIDATED"}
# Subtest: Log Redaction
    # Subtest: should redact sensitive keys in objects
    ok 1 - should redact sensitive keys in objects
      ---
      duration_ms: 20.780462
      ...
    1..1
ok 28 - Log Redaction
  ---
  duration_ms: 35.666836
  type: 'suite'
  ...
# Subtest: RequestContext
    # Subtest: should throw when accessing context outside run()
    ok 1 - should throw when accessing context outside run()
      ---
      duration_ms: 2.437342
      ...
    # Subtest: should return context inside run()
    ok 2 - should return context inside run()
      ---
      duration_ms: 2.544522
      ...
    # Subtest: should maintain isolation between concurrent async requests
    ok 3 - should maintain isolation between concurrent async requests
      ---
      duration_ms: 66.93492
      ...
    # Subtest: should forbid set() usage
    ok 4 - should forbid set() usage
      ---
      duration_ms: 12.650423
      ...
    1..4
ok 29 - RequestContext
  ---
  duration_ms: 86.93266
  type: 'suite'
  ...
# Subtest: ParticipantResolver
    # Subtest: Resolution Context Validation
        # Subtest: should require requestId in context
        ok 1 - should require requestId in context
          ---
          duration_ms: 1.005299
          ...
        1..1
    ok 1 - Resolution Context Validation
      ---
      duration_ms: 2.228999
      type: 'suite'
      ...
    # Subtest: Resolution Failure Reasons
        # Subtest: should define all expected failure reasons
        ok 1 - should define all expected failure reasons
          ---
          duration_ms: 0.5769
          ...
        # Subtest: should include CERTIFICATE_REVOKED for trust fabric failures
        ok 2 - should include CERTIFICATE_REVOKED for trust fabric failures
          ---
          duration_ms: 0.433499
          ...
        # Subtest: should include FINGERPRINT_NOT_FOUND for unknown certs
        ok 3 - should include FINGERPRINT_NOT_FOUND for unknown certs
          ---
          duration_ms: 3.752998
          ...
        # Subtest: should include PARTICIPANT_SUSPENDED for inactive participants
        ok 4 - should include PARTICIPANT_SUSPENDED for inactive participants
          ---
          duration_ms: 0.4769
          ...
        1..4
    ok 2 - Resolution Failure Reasons
      ---
      duration_ms: 6.566897
      type: 'suite'
      ...
    # Subtest: Resolution Flow Steps
        # Subtest: should have 5 resolution steps
        ok 1 - should have 5 resolution steps
          ---
          duration_ms: 0.5725
          ...
        # Subtest: should validate certificate before participant lookup
        ok 2 - should validate certificate before participant lookup
          ---
          duration_ms: 0.55
          ...
        1..2
    ok 3 - Resolution Flow Steps
      ---
      duration_ms: 1.711999
      type: 'suite'
      ...
    1..3
ok 30 - ParticipantResolver
  ---
  duration_ms: 13.871092
  type: 'suite'
  ...
# {"level":50,"time":1768711270998,"system":"symphony","incidentId":"6bc86afa-bbe5-4e44-81d7-a5faf6e3a1a9","category":"SEC","internalDetails":{"secret":"[REDACTED]"},"stack":"Error: Test error\\n    at TestContext.<anonymous> (file:///home/mwiza/workspaces/Symphony/tests/unit/Sanitizer.spec.ts:31:23)\\n    at Test.runInAsyncScope (node:async_hooks:206:9)\\n    at Test.run (node:internal/test_runner/test:796:25)\\n    at async Promise.all (index 0)\\n    at async Suite.run (node:internal/test_runner/test:1135:7)\\n    at async Test.processPendingSubtests (node:internal/test_runner/test:526:7)","msg":"Test error"}
# Subtest: ErrorSanitizer
    # Subtest: should create SymphonyError with incidentId
    ok 1 - should create SymphonyError with incidentId
      ---
      duration_ms: 29.874187
      ...
    # Subtest: should sanitize raw errors into SymphonyError
    ok 2 - should sanitize raw errors into SymphonyError
      ---
      duration_ms: 1.027299
      ...
    # Subtest: should pass through existing SymphonyError unchanged
    ok 3 - should pass through existing SymphonyError unchanged
      ---
      duration_ms: 0.7619
      ...
    1..3
ok 31 - ErrorSanitizer
  ---
  duration_ms: 1086.511398
  type: 'suite'
  ...
# {"level":50,"time":1768711271016,"system":"symphony","incidentId":"4211bbec-0766-4f78-8a63-ff08af55a8b5","category":"OPS","internalDetails":{"originalError":"Database connection failed: password=secret123","stack":"Error: Database connection failed: password=secret123\\n    at TestContext.<anonymous> (file:///home/mwiza/workspaces/Symphony/tests/unit/Sanitizer.spec.ts:38:26)\\n    at Test.runInAsyncScope (node:async_hooks:206:9)\\n    at Test.run (node:internal/test_runner/test:796:25)\\n    at async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)","context":"db-op"},"stack":"Error: An internal system error occurred. Please contact support with ID: db-op\\n    at Object.sanitize (file:///home/mwiza/workspaces/Symphony/libs/errors/sanitizer.ts:60:16)\\n    at TestContext.<anonymous> (file:///home/mwiza/workspaces/Symphony/tests/unit/Sanitizer.spec.ts:39:42)\\n    at Test.runInAsyncScope (node:async_hooks:206:9)\\n    at Test.run (node:internal/test_runner/test:796:25)\\n    at async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)","msg":"An internal system error occurred. Please contact support with ID: db-op"}
# {"level":50,"time":1768711271017,"system":"symphony","incidentId":"94fcb868-2b48-4328-ad75-beb7f530748a","category":"OPS","internalDetails":{"data":"test"},"stack":"Error: Original\\n    at TestContext.<anonymous> (file:///home/mwiza/workspaces/Symphony/tests/unit/Sanitizer.spec.ts:46:26)\\n    at Test.runInAsyncScope (node:async_hooks:206:9)\\n    at Test.run (node:internal/test_runner/test:796:25)\\n    at async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)","msg":"Original"}
# Subtest: ShortLivedCertificateManager
    # Subtest: Certificate Issuance
        # Subtest: should issue certificate with correct TTL
        ok 1 - should issue certificate with correct TTL
          ---
          duration_ms: 2.405679
          ...
        # Subtest: should reject TTL > 24 hours
        ok 2 - should reject TTL > 24 hours
          ---
          duration_ms: 0.445878
          ...
        # Subtest: should default to 4-hour TTL
        ok 3 - should default to 4-hour TTL
          ---
          duration_ms: 0.40678
          ...
        # Subtest: should calculate correct renewal window (30 min before expiry)
        ok 4 - should calculate correct renewal window (30 min before expiry)
          ---
          duration_ms: 7.725613
          ...
        1..4
    ok 1 - Certificate Issuance
      ---
      duration_ms: 13.057646
      type: 'suite'
      ...
    # Subtest: Certificate Revocation
        # Subtest: should mark certificate as revoked
        ok 1 - should mark certificate as revoked
          ---
          duration_ms: 0.668066
          ...
        # Subtest: should add fingerprint to revoked set
        ok 2 - should add fingerprint to revoked set
          ---
          duration_ms: 0.473977
          ...
        1..2
    ok 2 - Certificate Revocation
      ---
      duration_ms: 1.819409
      type: 'suite'
      ...
    # Subtest: Kill-Switch: Revoke All for Participant
        # Subtest: should revoke all certificates for a participant
        ok 1 - should revoke all certificates for a participant
          ---
          duration_ms: 0.774061
          ...
        1..1
    ok 3 - Kill-Switch: Revoke All for Participant
      ---
      duration_ms: 1.767112
      type: 'suite'
      ...
    # Subtest: Certificate Validation
        # Subtest: should reject revoked certificates
        ok 1 - should reject revoked certificates
          ---
          duration_ms: 0.531673
          ...
        # Subtest: should reject expired certificates
        ok 2 - should reject expired certificates
          ---
          duration_ms: 0.470576
          ...
        # Subtest: should accept valid certificates
        ok 3 - should accept valid certificates
          ---
          duration_ms: 0.515674
          ...
        1..3
    ok 4 - Certificate Validation
      ---
      duration_ms: 4.759762
      type: 'suite'
      ...
    # Subtest: Revocation Bounds for Evidence Bundle
        # Subtest: should calculate worst-case revocation window
        ok 1 - should calculate worst-case revocation window
          ---
          duration_ms: 0.469177
          ...
        # Subtest: should return correct bounds object
        ok 2 - should return correct bounds object
          ---
          duration_ms: 2.185091
          ...
        1..2
    ok 5 - Revocation Bounds for Evidence Bundle
      ---
      duration_ms: 3.002349
      type: 'suite'
      ...
    # Subtest: Suspended Participant Protection
        # Subtest: should block certificate issuance for suspended participant
        ok 1 - should block certificate issuance for suspended participant
          ---
          duration_ms: 0.985651
          ...
        1..1
    ok 6 - Suspended Participant Protection
      ---
      duration_ms: 1.291535
      type: 'suite'
      ...
    1..6
ok 32 - ShortLivedCertificateManager
  ---
  duration_ms: 28.942251
  type: 'suite'
  ...
# Subtest: CertificateError
    # Subtest: should have correct error codes
    ok 1 - should have correct error codes
      ---
      duration_ms: 7.112344
      ...
    1..1
ok 33 - CertificateError
  ---
  duration_ms: 7.38433
  type: 'suite'
  ...
# Subtest: TrustFabric (SEC-FIX)
    # Subtest: TrustViolationError
        # Subtest: should have correct error codes defined
        ok 1 - should have correct error codes defined
          ---
          duration_ms: 4.2132
          ...
        # Subtest: should extend Error with correct name
        ok 2 - should extend Error with correct name
          ---
          duration_ms: 0.7216
          ...
        1..2
    ok 1 - TrustViolationError
      ---
      duration_ms: 6.791999
      type: 'suite'
      ...
    # Subtest: Implementation Verification
        # Subtest: should exist and be readable
        ok 1 - should exist and be readable
          ---
          duration_ms: 19.618896
          ...
        # Subtest: should use async resolveIdentity
        ok 2 - should use async resolveIdentity
          ---
          duration_ms: 0.638
          ...
        # Subtest: should import and use LRUCache
        ok 3 - should import and use LRUCache
          ---
          duration_ms: 1.3631
          ...
        # Subtest: should check revoked status
        ok 4 - should check revoked status
          ---
          duration_ms: 0.7483
          ...
        # Subtest: should check expiry
        ok 5 - should check expiry
          ---
          duration_ms: 0.8514
          ...
        # Subtest: should check participant status
        ok 6 - should check participant status
          ---
          duration_ms: 8.342699
          ...
        # Subtest: should check environment binding
        ok 7 - should check environment binding
          ---
          duration_ms: 0.654299
          ...
        # Subtest: should use queryAsRole for scoped DB access
        ok 8 - should use queryAsRole for scoped DB access
          ---
          duration_ms: 3.1293
          ...
        # Subtest: should have stampede avoidance (inflight map)
        ok 9 - should have stampede avoidance (inflight map)
          ---
          duration_ms: 0.6774
          ...
        # Subtest: should have negative cache
        ok 10 - should have negative cache
          ---
          duration_ms: 0.4773
          ...
        1..10
    ok 2 - Implementation Verification
      ---
      duration_ms: 38.692093
      type: 'suite'
      ...
    1..2
ok 34 - TrustFabric (SEC-FIX)
  ---
  duration_ms: 47.51779
  type: 'suite'
  ...
# {"level":30,"time":1768711292807,"system":"symphony","msg":"Configuration guard passed."}
# Subtest: VerifyIdentity (Phase 7B Hardening)
    # Subtest: should verify a valid CLIENT identity
    ok 1 - should verify a valid CLIENT identity # SKIP
      ---
      duration_ms: 1.93499
      ...
    # Subtest: should verify a valid SERVICE identity
    ok 2 - should verify a valid SERVICE identity # SKIP
      ---
      duration_ms: 8.127074
      ...
    # Subtest: should verify a valid USER identity at Ingest boundary
    ok 3 - should verify a valid USER identity at Ingest boundary # SKIP
      ---
      duration_ms: 0.561571
      ...
    # Subtest: should REJECT service identity if mTLS fingerprint mismatches
    ok 4 - should REJECT service identity if mTLS fingerprint mismatches
      ---
      duration_ms: 59.401287
      ...
    # Subtest: should REJECT service identity if mTLS fingerprint missing from envelope
    ok 5 - should REJECT service identity if mTLS fingerprint missing from envelope
      ---
      duration_ms: 15.174547
      ...
    # Subtest: should PREVENT USER LAUNDERING: reject user envelope at internal service boundary
    ok 6 - should PREVENT USER LAUNDERING: reject user envelope at internal service boundary
      ---
      duration_ms: 15.800687
      ...
    # Subtest: should REJECT user identity if issuer is not ingest-api
    ok 7 - should REJECT user identity if issuer is not ingest-api
      ---
      duration_ms: 1.360091
      ...
    # Subtest: should REJECT user identity if trustTier is not user
    ok 8 - should REJECT user identity if trustTier is not user
      ---
      duration_ms: 1.587167
      ...
    1..8
ok 35 - VerifyIdentity (Phase 7B Hardening)
  ---
  duration_ms: 6974.903923
  type: 'suite'
  ...
# {"level":40,"time":1768711296855,"system":"symphony","context":"test-context","errors":[{"path":"id","message":"Invalid UUID"},{"path":"amount","message":"Too small: expected number to be >0"},{"path":"currency","message":"Invalid option: expected one of \\"USD\\"|\\"EUR\\"|\\"GBP\\""}],"msg":"Input Validation Failure (HIGH-SEC-002)"}
# Subtest: Zod Middleware
    # Subtest: should validate correct input
    ok 1 - should validate correct input
      ---
      duration_ms: 4.892179
      ...
    # Subtest: should reject invalid input with detailed error
    ok 2 - should reject invalid input with detailed error
      ---
      duration_ms: 5.842843
      ...
    # Subtest: should reject missing required fields
    ok 3 - should reject missing required fields
      ---
      duration_ms: 1.604159
      ...
    # Subtest: should create reusable validator factory
    ok 4 - should create reusable validator factory
      ---
      duration_ms: 0.475729
      ...
    1..4
ok 36 - Zod Middleware
  ---
  duration_ms: 427.366147
  type: 'suite'
  ...
# {"level":40,"time":1768711296859,"system":"symphony","context":"partial-test","errors":[{"path":"amount","message":"Invalid input: expected number, received undefined"},{"path":"currency","message":"Invalid option: expected one of \\"USD\\"|\\"EUR\\"|\\"GBP\\""}],"msg":"Input Validation Failure (HIGH-SEC-002)"}
# {"level":30,"time":1768711291643,"pid":32514,"hostname":"DESKTOP-VV0116A","name":"ZombieRepairWorker","event":"REPAIR_CYCLE_COMPLETE","zombiesRepaired":1,"recordsEscalated":1,"attestationsReconciled":1}
# Subtest: ZombieRepairWorker
    # Subtest: runRepairCycle()
        # Subtest: should execute repair queries with correct SQL
        ok 1 - should execute repair queries with correct SQL
          ---
          duration_ms: 15.157973
          ...
        # Subtest: should define transaction boundaries
        ok 2 - should define transaction boundaries
          ---
          duration_ms: 1.35887
          ...
        # Subtest: should rollback on error
        ok 3 - should rollback on error
          ---
          duration_ms: 5.142795
          ...
        1..3
    ok 1 - runRepairCycle()
      ---
      duration_ms: 23.62901
      type: 'suite'
      ...
    # Subtest: getZombieCount()
        # Subtest: should return count from DB
        ok 1 - should return count from DB
          ---
          duration_ms: 1.463429
          ...
        1..1
    ok 2 - getZombieCount()
      ---
      duration_ms: 1.795041
      type: 'suite'
      ...
    1..2
ok 37 - ZombieRepairWorker
  ---
  duration_ms: 26.6079
  type: 'suite'
  ...
# {"level":50,"time":1768711291656,"pid":32514,"hostname":"DESKTOP-VV0116A","name":"ZombieRepairWorker","error":"DB Failure","msg":"Repair cycle failed"}
# Sanity loading
# Subtest: Sanity
    # Subtest: should pass
    ok 1 - should pass
      ---
      duration_ms: 1.63287
      ...
    1..1
ok 38 - Sanity
  ---
  duration_ms: 5.904137
  type: 'suite'
  ...
1..38
# tests 213
# suites 107
# pass 206
# fail 4
# cancelled 0
# skipped 3
# todo 0
# duration_ms 167607.807394
