
> symphony@1.0.0 test
> node --import ./tests/loader.mjs --test tests/*.test.js tests/*.test.ts tests/unit/*.spec.ts

TAP version 13
# Subtest: ConfigGuard Module
    # Subtest: Module Exports
        # Subtest: should have ConfigGuard class
        ok 1 - should have ConfigGuard class
          ---
          duration_ms: 6.018355
          ...
        # Subtest: should have DB_CONFIG_GUARDS
        ok 2 - should have DB_CONFIG_GUARDS
          ---
          duration_ms: 9.131259
          ...
        # Subtest: should have CRYPTO_GUARDS
        ok 3 - should have CRYPTO_GUARDS
          ---
          duration_ms: 1.011107
          ...
        1..3
    ok 1 - Module Exports
      ---
      duration_ms: 22.60386
      type: 'suite'
      ...
    # Subtest: DB_CONFIG_GUARDS
        # Subtest: should include all required database config keys
        ok 1 - should include all required database config keys
          ---
          duration_ms: 1.7409
          ...
        # Subtest: should mark DB_PASSWORD as sensitive
        ok 2 - should mark DB_PASSWORD as sensitive
          ---
          duration_ms: 11.786995
          ...
        1..2
    ok 2 - DB_CONFIG_GUARDS
      ---
      duration_ms: 14.244655
      type: 'suite'
      ...
    # Subtest: PROD_CRYPTO_GUARDS
        # Subtest: should include required KMS config keys
        ok 1 - should include required KMS config keys
          ---
          duration_ms: 1.422363
          ...
        1..1
    ok 3 - PROD_CRYPTO_GUARDS
      ---
      duration_ms: 6.00463
      type: 'suite'
      ...
    1..3
ok 1 - ConfigGuard Module
  ---
  duration_ms: 43.997848
  type: 'suite'
  ...
# file:///home/mwiza/workspaces/Symphony/tests/failure-classification.test.ts:5
# import { describe, it, expect } from '@jest/globals';
#          ^^^^^^^^
# SyntaxError: Named export 'describe' not found. The requested module '@jest/globals' is a CommonJS module, which may not support all module.exports as named exports.
# CommonJS modules can always be imported via the default export, for example using:
# import pkg from '@jest/globals';
# const { describe, it, expect } = pkg;
#     at ModuleJob._instantiate (node:internal/modules/esm/module_job:213:21)
#     at async ModuleJob.run (node:internal/modules/esm/module_job:320:5)
#     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
#     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
# Node.js v20.19.6
# Subtest: /home/mwiza/workspaces/Symphony/tests/failure-classification.test.ts
not ok 2 - /home/mwiza/workspaces/Symphony/tests/failure-classification.test.ts
  ---
  duration_ms: 14322.487864
  location: '/home/mwiza/workspaces/Symphony/tests/failure-classification.test.ts:1:1'
  failureType: 'testCodeFailure'
  exitCode: 1
  signal: ~
  error: 'test failed'
  code: 'ERR_TEST_FAILURE'
  ...
# KeyManager tests loaded successfully
# Subtest: KeyManager Module
    # Subtest: Module Exports
        # Subtest: should export KeyManager interface
        ok 1 - should export KeyManager interface
          ---
          duration_ms: 13171.074408
          ...
        # Subtest: should export SymphonyKeyManager class
        ok 2 - should export SymphonyKeyManager class
          ---
          duration_ms: 7.328114
          ...
        # Subtest: should export ProductionKeyManager as alias for SymphonyKeyManager
        ok 3 - should export ProductionKeyManager as alias for SymphonyKeyManager
          ---
          duration_ms: 12.010618
          ...
        # Subtest: should export DevelopmentKeyManager class
        ok 4 - should export DevelopmentKeyManager class
          ---
          duration_ms: 1387.726179
          ...
        # Subtest: should export cryptoAudit helper
        ok 5 - should export cryptoAudit helper
          ---
          duration_ms: 86.566967
          ...
        1..5
    ok 1 - Module Exports
      ---
      duration_ms: 14666.851968
      type: 'suite'
      ...
# {"level":30,"time":1768710880209,"system":"symphony","msg":"Configuration guard passed."}
    # Subtest: DevelopmentKeyManager
        # Subtest: should extend SymphonyKeyManager
        ok 1 - should extend SymphonyKeyManager
          ---
          duration_ms: 102.855913
          ...
        # Subtest: should have deriveKey method
        ok 2 - should have deriveKey method
          ---
          duration_ms: 10.719112
          ...
        1..2
    ok 2 - DevelopmentKeyManager
      ---
      duration_ms: 114.181899
      type: 'suite'
      ...
    # Subtest: SymphonyKeyManager
        # Subtest: should create instance successfully
        ok 1 - should create instance successfully
          ---
          duration_ms: 34.386284
          ...
# {"level":30,"time":1768710880244,"system":"symphony","msg":"DevelopmentKeyManager initialized (dev/prod parity via local-kms)"}
# {"level":30,"time":1768710880264,"system":"symphony","msg":"Configuration guard passed."}
# {"level":30,"time":1768710880271,"system":"symphony","msg":"DevelopmentKeyManager initialized (dev/prod parity via local-kms)"}
        # Subtest: should have deriveKey method
        ok 2 - should have deriveKey method
          ---
          duration_ms: 19.431187
          ...
        1..2
    ok 3 - SymphonyKeyManager
      ---
      duration_ms: 57.987838
      type: 'suite'
      ...
    1..3
ok 3 - KeyManager Module
  ---
  duration_ms: 14840.718775
  type: 'suite'
  ...
# {"level":30,"time":1768710888780,"system":"symphony","msg":"Configuration guard passed."}
# Subtest: E. Ledger & Financial Invariants
    # Subtest: E-2 Proof-of-Funds
        # Subtest: should allow transaction if balance >= amount
        ok 1 - should allow transaction if balance >= amount
          ---
          duration_ms: 16.532994
          ...
        # Subtest: should reject transaction if balance < amount
        ok 2 - should reject transaction if balance < amount
          ---
          duration_ms: 16.001026
          ...
        # Subtest: should reject if account not found
        ok 3 - should reject if account not found
          ---
          duration_ms: 0.841697
          ...
        1..3
    ok 1 - E-2 Proof-of-Funds
      ---
      duration_ms: 35.431344
      type: 'suite'
      ...
    # Subtest: E-3 Idempotency
        # Subtest: should allow new transaction ID
        ok 1 - should allow new transaction ID
          ---
          duration_ms: 1.03047
          ...
        # Subtest: should reject duplicate transaction ID
        ok 2 - should reject duplicate transaction ID
          ---
          duration_ms: 1.002534
          ...
        1..2
    ok 2 - E-3 Idempotency
      ---
      duration_ms: 2.590643
      type: 'suite'
      ...
    1..2
ok 4 - E. Ledger & Financial Invariants
  ---
  duration_ms: 10495.053352
  type: 'suite'
  ...
# {"level":40,"time":1768710888819,"system":"symphony","accountId":"ACC_123","currentBalance":50,"required":100,"msg":"LedgerInvariant: Insufficient funds"}
# file:///home/mwiza/workspaces/Symphony/tests/participant-identity.test.ts:11
# import { describe, it, expect } from '@jest/globals';
#          ^^^^^^^^
# SyntaxError: Named export 'describe' not found. The requested module '@jest/globals' is a CommonJS module, which may not support all module.exports as named exports.
# CommonJS modules can always be imported via the default export, for example using:
# import pkg from '@jest/globals';
# const { describe, it, expect } = pkg;
#     at ModuleJob._instantiate (node:internal/modules/esm/module_job:213:21)
#     at async ModuleJob.run (node:internal/modules/esm/module_job:320:5)
#     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
#     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
# Node.js v20.19.6
# Subtest: /home/mwiza/workspaces/Symphony/tests/participant-identity.test.ts
not ok 5 - /home/mwiza/workspaces/Symphony/tests/participant-identity.test.ts
  ---
  duration_ms: 16257.707846
  location: '/home/mwiza/workspaces/Symphony/tests/participant-identity.test.ts:1:1'
  failureType: 'testCodeFailure'
  exitCode: 1
  signal: ~
  error: 'test failed'
  code: 'ERR_TEST_FAILURE'
  ...
# {"level":50,"time":1768710897811,"system":"symphony","errors":[{"expected":"string","code":"invalid_type","path":["GrpHdr","MsgId"],"message":"Invalid input: expected string, received undefined"}],"type":"pacs.008","msg":"ISO-20022: Schema validation failed"}
# Subtest: D. ISO-20022 Execution Control
    # Subtest: D-1 Structural Validation
        # Subtest: should accept valid pacs.008 message
        ok 1 - should accept valid pacs.008 message
          ---
          duration_ms: 17.143598
          ...
        # Subtest: should reject malformed schema (missing field)
        ok 2 - should reject malformed schema (missing field)
          ---
          duration_ms: 14.15471
          ...
        # Subtest: should accept valid pacs.002 message
        ok 3 - should accept valid pacs.002 message
          ---
          duration_ms: 2.633728
          ...
        1..3
    ok 1 - D-1 Structural Validation
      ---
      duration_ms: 43.517098
      type: 'suite'
      ...
    # Subtest: D-2 Semantic Execution Validation
        # Subtest: should enforce positive amounts (Schema Level)
        ok 1 - should enforce positive amounts (Schema Level)
          ---
          duration_ms: 6.934989
          ...
        # Subtest: should enforce currency consistency
        ok 2 - should enforce currency consistency
          ---
          duration_ms: 9.272178
          ...
        # Subtest: should enforce instruction uniqueness
        ok 3 - should enforce instruction uniqueness
          ---
          duration_ms: 1.283012
          ...
        1..3
    ok 2 - D-2 Semantic Execution Validation
      ---
      duration_ms: 18.348011
      type: 'suite'
      ...
    # Subtest: D-4 Deterministic Mapping
        # Subtest: should map inbound pacs.008 deterministically
        ok 1 - should map inbound pacs.008 deterministically
          ---
          duration_ms: 0.950959
          ...
        # Subtest: should fail outbound mapping if non-deterministic (missing date)
        ok 2 - should fail outbound mapping if non-deterministic (missing date)
          ---
          duration_ms: 2.99484
          ...
        1..2
    ok 3 - D-4 Deterministic Mapping
      ---
      duration_ms: 4.61364
      type: 'suite'
      ...
    1..3
ok 6 - D. ISO-20022 Execution Control
  ---
  duration_ms: 68.245967
  type: 'suite'
  ...
# {"level":50,"time":1768710897820,"system":"symphony","incidentId":"b570438d-5cc0-46e5-9762-56790867a341","category":"OPS","internalDetails":{"originalError":"[\\n  {\\n    \\"expected\\": \\"string\\",\\n    \\"code\\": \\"invalid_type\\",\\n    \\"path\\": [\\n      \\"GrpHdr\\",\\n      \\"MsgId\\"\\n    ],\\n    \\"message\\": \\"Invalid input: expected string, received undefined\\"\\n  }\\n]","stack":"ZodError: [\\n  {\\n    \\"expected\\": \\"string\\",\\n    \\"code\\": \\"invalid_type\\",\\n    \\"path\\": [\\n      \\"GrpHdr\\",\\n      \\"MsgId\\"\\n    ],\\n    \\"message\\": \\"Invalid input: expected string, received undefined\\"\\n  }\\n]\\n    at Iso20022Validator.validateSchema (file:///home/mwiza/workspaces/Symphony/libs/iso20022/validator.ts:97:55)\\n    at file:///home/mwiza/workspaces/Symphony/tests/phase7-compliance.test.js:46:35\\n    at getActual (node:assert:498:5)\\n    at Function.throws (node:assert:644:24)\\n    at TestContext.<anonymous> (file:///home/mwiza/workspaces/Symphony/tests/phase7-compliance.test.js:45:20)\\n    at Test.runInAsyncScope (node:async_hooks:206:9)\\n    at Test.run (node:internal/test_runner/test:796:25)\\n    at Suite.processPendingSubtests (node:internal/test_runner/test:526:18)\\n    at Test.postRun (node:internal/test_runner/test:889:19)\\n    at Test.run (node:internal/test_runner/test:835:12)","context":"ISO20022:SchemaValidation"},"stack":"Error: An internal system error occurred. Please contact support with ID: ISO20022:SchemaValidation\\n    at Object.sanitize (file:///home/mwiza/workspaces/Symphony/libs/errors/sanitizer.ts:60:16)\\n    at Iso20022Validator.validateSchema (file:///home/mwiza/workspaces/Symphony/libs/iso20022/validator.ts:107:34)\\n    at file:///home/mwiza/workspaces/Symphony/tests/phase7-compliance.test.js:46:35\\n    at getActual (node:assert:498:5)\\n    at Function.throws (node:assert:644:24)\\n    at TestContext.<anonymous> (file:///home/mwiza/workspaces/Symphony/tests/phase7-compliance.test.js:45:20)\\n    at Test.runInAsyncScope (node:async_hooks:206:9)\\n    at Test.run (node:internal/test_runner/test:796:25)\\n    at Suite.processPendingSubtests (node:internal/test_runner/test:526:18)\\n    at Test.postRun (node:internal/test_runner/test:889:19)","msg":"An internal system error occurred. Please contact support with ID: ISO20022:SchemaValidation"}
# {"level":50,"time":1768710897830,"system":"symphony","errors":[{"origin":"number","code":"too_small","minimum":0,"inclusive":false,"path":["CdtTrfTxInf",0,"IntrBkSttlmAmt","Amount"],"message":"Too small: expected number to be >0"}],"type":"pacs.008","msg":"ISO-20022: Schema validation failed"}
# {"level":50,"time":1768710897835,"system":"symphony","incidentId":"53229d2a-9895-42dc-bf97-ff768bd98a2c","category":"OPS","internalDetails":{"originalError":"[\\n  {\\n    \\"origin\\": \\"number\\",\\n    \\"code\\": \\"too_small\\",\\n    \\"minimum\\": 0,\\n    \\"inclusive\\": false,\\n    \\"path\\": [\\n      \\"CdtTrfTxInf\\",\\n      0,\\n      \\"IntrBkSttlmAmt\\",\\n      \\"Amount\\"\\n    ],\\n    \\"message\\": \\"Too small: expected number to be >0\\"\\n  }\\n]","stack":"ZodError: [\\n  {\\n    \\"origin\\": \\"number\\",\\n    \\"code\\": \\"too_small\\",\\n    \\"minimum\\": 0,\\n    \\"inclusive\\": false,\\n    \\"path\\": [\\n      \\"CdtTrfTxInf\\",\\n      0,\\n      \\"IntrBkSttlmAmt\\",\\n      \\"Amount\\"\\n    ],\\n    \\"message\\": \\"Too small: expected number to be >0\\"\\n  }\\n]\\n    at Iso20022Validator.validateSchema (file:///home/mwiza/workspaces/Symphony/libs/iso20022/validator.ts:97:55)\\n    at file:///home/mwiza/workspaces/Symphony/tests/phase7-compliance.test.js:70:35\\n    at getActual (node:assert:498:5)\\n    at Function.throws (node:assert:644:24)\\n    at TestContext.<anonymous> (file:///home/mwiza/workspaces/Symphony/tests/phase7-compliance.test.js:69:20)\\n    at Test.runInAsyncScope (node:async_hooks:206:9)\\n    at Test.run (node:internal/test_runner/test:796:25)\\n    at Test.start (node:internal/test_runner/test:702:17)\\n    at node:internal/test_runner/test:1133:71\\n    at node:internal/per_context/primordials:482:82","context":"ISO20022:SchemaValidation"},"stack":"Error: An internal system error occurred. Please contact support with ID: ISO20022:SchemaValidation\\n    at Object.sanitize (file:///home/mwiza/workspaces/Symphony/libs/errors/sanitizer.ts:60:16)\\n    at Iso20022Validator.validateSchema (file:///home/mwiza/workspaces/Symphony/libs/iso20022/validator.ts:107:34)\\n    at file:///home/mwiza/workspaces/Symphony/tests/phase7-compliance.test.js:70:35\\n    at getActual (node:assert:498:5)\\n    at Function.throws (node:assert:644:24)\\n    at TestContext.<anonymous> (file:///home/mwiza/workspaces/Symphony/tests/phase7-compliance.test.js:69:20)\\n    at Test.runInAsyncScope (node:async_hooks:206:9)\\n    at Test.run (node:internal/test_runner/test:796:25)\\n    at Test.start (node:internal/test_runner/test:702:17)\\n    at node:internal/test_runner/test:1133:71","msg":"An internal system error occurred. Please contact support with ID: ISO20022:SchemaValidation"}
# {"level":40,"time":1768710897844,"system":"symphony","msg":"ISO-20022: Semantic failure - Multi-currency batch not supported in Phase 7"}
# {"level":40,"time":1768710897846,"system":"symphony","msg":"ISO-20022: Semantic failure - Duplicate TxIds in batch"}
# file:///home/mwiza/workspaces/Symphony/tests/repair-workflow.test.ts:5
# import { describe, it, expect, jest } from '@jest/globals';
#          ^^^^^^^^
# SyntaxError: Named export 'describe' not found. The requested module '@jest/globals' is a CommonJS module, which may not support all module.exports as named exports.
# CommonJS modules can always be imported via the default export, for example using:
# import pkg from '@jest/globals';
# const { describe, it, expect, jest } = pkg;
#     at ModuleJob._instantiate (node:internal/modules/esm/module_job:213:21)
#     at async ModuleJob.run (node:internal/modules/esm/module_job:320:5)
#     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
#     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
# Node.js v20.19.6
# Subtest: /home/mwiza/workspaces/Symphony/tests/repair-workflow.test.ts
not ok 7 - /home/mwiza/workspaces/Symphony/tests/repair-workflow.test.ts
  ---
  duration_ms: 12530.239771
  location: '/home/mwiza/workspaces/Symphony/tests/repair-workflow.test.ts:1:1'
  failureType: 'testCodeFailure'
  exitCode: 1
  signal: ~
  error: 'test failed'
  code: 'ERR_TEST_FAILURE'
  ...
# file:///home/mwiza/workspaces/Symphony/tests/retry-eligibility.test.ts:5
# import { describe, it, expect, jest } from '@jest/globals';
#          ^^^^^^^^
# SyntaxError: Named export 'describe' not found. The requested module '@jest/globals' is a CommonJS module, which may not support all module.exports as named exports.
# CommonJS modules can always be imported via the default export, for example using:
# import pkg from '@jest/globals';
# const { describe, it, expect, jest } = pkg;
#     at ModuleJob._instantiate (node:internal/modules/esm/module_job:213:21)
#     at async ModuleJob.run (node:internal/modules/esm/module_job:320:5)
#     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
#     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
# Node.js v20.19.6
# Subtest: /home/mwiza/workspaces/Symphony/tests/retry-eligibility.test.ts
not ok 8 - /home/mwiza/workspaces/Symphony/tests/retry-eligibility.test.ts
  ---
  duration_ms: 12203.091704
  location: '/home/mwiza/workspaces/Symphony/tests/retry-eligibility.test.ts:1:1'
  failureType: 'testCodeFailure'
  exitCode: 1
  signal: ~
  error: 'test failed'
  code: 'ERR_TEST_FAILURE'
  ...
# file:///home/mwiza/workspaces/Symphony/tests/runtime-guards.test.ts:11
# import { describe, it, expect, jest } from '@jest/globals';
#          ^^^^^^^^
# SyntaxError: Named export 'describe' not found. The requested module '@jest/globals' is a CommonJS module, which may not support all module.exports as named exports.
# CommonJS modules can always be imported via the default export, for example using:
# import pkg from '@jest/globals';
# const { describe, it, expect, jest } = pkg;
#     at ModuleJob._instantiate (node:internal/modules/esm/module_job:213:21)
#     at async ModuleJob.run (node:internal/modules/esm/module_job:320:5)
#     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
#     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
# Node.js v20.19.6
# Subtest: /home/mwiza/workspaces/Symphony/tests/runtime-guards.test.ts
not ok 9 - /home/mwiza/workspaces/Symphony/tests/runtime-guards.test.ts
  ---
  duration_ms: 16761.365921
  location: '/home/mwiza/workspaces/Symphony/tests/runtime-guards.test.ts:1:1'
  failureType: 'testCodeFailure'
  exitCode: 1
  signal: ~
  error: 'test failed'
  code: 'ERR_TEST_FAILURE'
  ...
# {"level":30,"time":1768710913862,"system":"symphony","msg":"Configuration guard passed."}
# Subtest: F. Operational Safety Controls
    # Subtest: F-1 Rate Limiting
        # Subtest: should allow requests within capacity
        ok 1 - should allow requests within capacity
          ---
          duration_ms: 9.52845
          ...
        # Subtest: should reject requests exceeding capacity
        ok 2 - should reject requests exceeding capacity
          ---
          duration_ms: 1.050856
          ...
# {"level":40,"time":1768710913901,"system":"symphony","principalId":"user_2","msg":"OperationalSafety: Rate limit exceeded"}
# {"level":40,"time":1768710913902,"system":"symphony","principalId":"user_3","msg":"OperationalSafety: Rate limit exceeded"}
        # Subtest: should refill tokens over time
        ok 3 - should refill tokens over time
          ---
          duration_ms: 158.155353
          ...
        1..3
    ok 1 - F-1 Rate Limiting
      ---
      duration_ms: 194.565233
      type: 'suite'
      ...
    # Subtest: F-2 Fail-Safe Behavior
        # Subtest: should commit transaction on success
        ok 1 - should commit transaction on success
          ---
          duration_ms: 0.420407
          ...
        1..1
    ok 2 - F-2 Fail-Safe Behavior
      ---
      duration_ms: 0.718212
      type: 'suite'
      ...
    1..2
ok 10 - F. Operational Safety Controls
  ---
  duration_ms: 2919.091341
  type: 'suite'
  ...
# Subtest: verifyAuditChain (Integrity)
    # Subtest: should verify a valid chain
    ok 1 - should verify a valid chain
      ---
      duration_ms: 19.73795
      ...
    # Subtest: should detect tamper (broken chain)
    ok 2 - should detect tamper (broken chain)
      ---
      duration_ms: 24.803319
      ...
    # Subtest: should handle malformed JSON safely (no eval)
    ok 3 - should handle malformed JSON safely (no eval)
      ---
      duration_ms: 7.752282
      ...
    1..3
ok 11 - verifyAuditChain (Integrity)
  ---
  duration_ms: 81.043105
  type: 'suite'
  ...
# Subtest: Authorization Engine Guards
    # Subtest: Guard 1: Emergency Lockdown
        # Subtest: should block all capabilities when EMERGENCY_LOCKDOWN is active
        ok 1 - should block all capabilities when EMERGENCY_LOCKDOWN is active
          ---
          duration_ms: 1.841376
          ...
        1..1
    ok 1 - Guard 1: Emergency Lockdown
      ---
      duration_ms: 3.400431
      type: 'suite'
      ...
    # Subtest: Guard 2: OU Boundary Assertion
        # Subtest: should deny when service attempts capability it does not own
        ok 1 - should deny when service attempts capability it does not own
          ---
          duration_ms: 0.610365
          ...
        # Subtest: should allow when service owns the capability
        ok 2 - should allow when service owns the capability
          ---
          duration_ms: 0.344116
          ...
        1..2
    ok 2 - Guard 2: OU Boundary Assertion
      ---
      duration_ms: 1.400524
      type: 'suite'
      ...
    # Subtest: Guard 3: Client Restriction Invariant
        # Subtest: should block clients from execution-class activities
        ok 1 - should block clients from execution-class activities
          ---
          duration_ms: 0.96077
          ...
        # Subtest: should allow clients for non-restricted activities
        ok 2 - should allow clients for non-restricted activities
          ---
          duration_ms: 0.58351
          ...
        1..2
    ok 3 - Guard 3: Client Restriction Invariant
      ---
      duration_ms: 2.180301
      type: 'suite'
      ...
    # Subtest: Guard 4: Policy Version Parity
        # Subtest: should deny when policy versions mismatch
        ok 1 - should deny when policy versions mismatch
          ---
          duration_ms: 0.76001
          ...
        # Subtest: should allow when policy versions match
        ok 2 - should allow when policy versions match
          ---
          duration_ms: 0.641611
          ...
        1..2
    ok 4 - Guard 4: Policy Version Parity
      ---
      duration_ms: 2.058607
      type: 'suite'
      ...
    1..4
ok 12 - Authorization Engine Guards
  ---
  duration_ms: 22.47956
  type: 'suite'
  ...
# Subtest: IncidentContainment Rules
    # Subtest: Rule 1: SEC-2 + CRITICAL triggers GLOBAL FREEZE
        # Subtest: should trigger global kill switch for integrity breach
        ok 1 - should trigger global kill switch for integrity breach
          ---
          duration_ms: 12.752663
          ...
        # Subtest: should NOT trigger for SEC-2 HIGH
        ok 2 - should NOT trigger for SEC-2 HIGH
          ---
          duration_ms: 0.556556
          ...
        1..2
    ok 1 - Rule 1: SEC-2 + CRITICAL triggers GLOBAL FREEZE
      ---
      duration_ms: 14.835929
      type: 'suite'
      ...
    # Subtest: Rule 2: SEC-1 + CRITICAL triggers SCOPED LOCK
        # Subtest: should trigger actor capability freeze for authz violation
        ok 1 - should trigger actor capability freeze for authz violation
          ---
          duration_ms: 0.501949
          ...
        1..1
    ok 2 - Rule 2: SEC-1 + CRITICAL triggers SCOPED LOCK
      ---
      duration_ms: 0.857844
      type: 'suite'
      ...
    # Subtest: No Action for Non-Critical
        # Subtest: should not trigger any action for non-critical signals
        ok 1 - should not trigger any action for non-critical signals
          ---
          duration_ms: 0.397126
          ...
        1..1
    ok 3 - No Action for Non-Critical
      ---
      duration_ms: 0.886895
      type: 'suite'
      ...
    1..3
ok 13 - IncidentContainment Rules
  ---
  duration_ms: 18.111871
  type: 'suite'
  ...
# Subtest: Database Configuration Guards
    # Subtest: should enforce TLS in production environment
    ok 1 - should enforce TLS in production environment
      ---
      duration_ms: 11810.54812
      ...
    # Subtest: should throw error if DB_CA_CERT is missing in production
    not ok 2 - should throw error if DB_CA_CERT is missing in production
      ---
      duration_ms: 9544.363183
      location: '/home/mwiza/workspaces/Symphony/tests/unit/DatabaseConfig.spec.ts:35:5'
      failureType: 'testCodeFailure'
      error: |-
        The input did not match the regular expression /CRITICAL: Missing DB_CA_CERT in protected environment/. Input:
        
        ''
        
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected:
      actual: ''
      operator: 'match'
      stack: |-
        TestContext.<anonymous> (file:///home/mwiza/workspaces/Symphony/tests/unit/DatabaseConfig.spec.ts:46:16)
        Test.runInAsyncScope (node:async_hooks:206:9)
        Test.run (node:internal/test_runner/test:796:25)
        Suite.processPendingSubtests (node:internal/test_runner/test:526:18)
        Test.postRun (node:internal/test_runner/test:889:19)
        Test.run (node:internal/test_runner/test:835:12)
        async Promise.all (index 0)
        async Suite.run (node:internal/test_runner/test:1135:7)
        async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: should throw error if DB_CA_CERT is missing in staging
    not ok 3 - should throw error if DB_CA_CERT is missing in staging
      ---
      duration_ms: 8116.421546
      location: '/home/mwiza/workspaces/Symphony/tests/unit/DatabaseConfig.spec.ts:48:5'
      failureType: 'testCodeFailure'
      error: |-
        The input did not match the regular expression /CRITICAL: Missing DB_CA_CERT in protected environment/. Input:
        
        ''
        
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected:
      actual: ''
      operator: 'match'
      stack: |-
        TestContext.<anonymous> (file:///home/mwiza/workspaces/Symphony/tests/unit/DatabaseConfig.spec.ts:59:16)
        Test.runInAsyncScope (node:async_hooks:206:9)
        Test.run (node:internal/test_runner/test:796:25)
        Suite.processPendingSubtests (node:internal/test_runner/test:526:18)
        Test.postRun (node:internal/test_runner/test:889:19)
        Test.run (node:internal/test_runner/test:835:12)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: should allow missing DB_CA_CERT in development (default)
    ok 4 - should allow missing DB_CA_CERT in development (default)
      ---
      duration_ms: 10060.84504
      ...
    1..4
not ok 14 - Database Configuration Guards
  ---
  duration_ms: 39546.122146
  type: 'suite'
  location: '/home/mwiza/workspaces/Symphony/tests/unit/DatabaseConfig.spec.ts:4:1'
  failureType: 'subtestsFailed'
  error: '2 subtests failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: Evidence Bundle Schema - Phase-7R Sections
    # Subtest: attestation_gap Section
        # Subtest: should validate complete attestation_gap object
        ok 1 - should validate complete attestation_gap object
          ---
          duration_ms: 10.502553
          ...
        # Subtest: should fail when gap > 0
        ok 2 - should fail when gap > 0
          ---
          duration_ms: 12.330675
          ...
        # Subtest: should require all fields
        ok 3 - should require all fields
          ---
          duration_ms: 0.577789
          ...
        # Subtest: should validate status enum
        ok 4 - should validate status enum
          ---
          duration_ms: 0.537622
          ...
        1..4
    ok 1 - attestation_gap Section
      ---
      duration_ms: 55.93654
      type: 'suite'
      ...
    # Subtest: dlq_metrics Section
        # Subtest: should validate complete dlq_metrics object
        ok 1 - should validate complete dlq_metrics object
          ---
          duration_ms: 0.764159
          ...
        # Subtest: should require all fields
        ok 2 - should require all fields
          ---
          duration_ms: 0.375051
          ...
        # Subtest: should enforce non-negative integers
        ok 3 - should enforce non-negative integers
          ---
          duration_ms: 8.286055
          ...
        1..3
    ok 2 - dlq_metrics Section
      ---
      duration_ms: 10.096038
      type: 'suite'
      ...
    # Subtest: revocation_bounds Section
        # Subtest: should validate complete revocation_bounds object
        ok 1 - should validate complete revocation_bounds object
          ---
          duration_ms: 1.276276
          ...
        # Subtest: should enforce cert_ttl_hours <= 24
        ok 2 - should enforce cert_ttl_hours <= 24
          ---
          duration_ms: 0.697283
          ...
        # Subtest: should correctly calculate worst_case
        ok 3 - should correctly calculate worst_case
          ---
          duration_ms: 0.659125
          ...
        # Subtest: should require ttl and propagation fields
        ok 4 - should require ttl and propagation fields
          ---
          duration_ms: 12.279162
          ...
        1..4
    ok 3 - revocation_bounds Section
      ---
      duration_ms: 18.28248
      type: 'suite'
      ...
    # Subtest: idempotency_metrics Section
        # Subtest: should validate complete idempotency_metrics object
        ok 1 - should validate complete idempotency_metrics object
          ---
          duration_ms: 0.675392
          ...
        # Subtest: should require terminal_reentry_attempts = 0 for healthy system
        ok 2 - should require terminal_reentry_attempts = 0 for healthy system
          ---
          duration_ms: 0.627896
          ...
        # Subtest: should require core fields
        ok 3 - should require core fields
          ---
          duration_ms: 0.513925
          ...
        # Subtest: should allow optional zombie_repairs field
        ok 4 - should allow optional zombie_repairs field
          ---
          duration_ms: 0.577688
          ...
        1..4
    ok 4 - idempotency_metrics Section
      ---
      duration_ms: 6.127531
      type: 'suite'
      ...
    # Subtest: evidence_export Section
        # Subtest: should validate complete evidence_export object
        ok 1 - should validate complete evidence_export object
          ---
          duration_ms: 0.635326
          ...
        # Subtest: should validate status enum
        ok 2 - should validate status enum
          ---
          duration_ms: 6.837165
          ...
        # Subtest: should validate export_target enum
        ok 3 - should validate export_target enum
          ---
          duration_ms: 0.791974
          ...
        # Subtest: should allow null for optional date fields
        ok 4 - should allow null for optional date fields
          ---
          duration_ms: 0.712445
          ...
        # Subtest: should require enabled and status fields
        ok 5 - should require enabled and status fields
          ---
          duration_ms: 0.647476
          ...
        1..5
    ok 5 - evidence_export Section
      ---
      duration_ms: 10.882187
      type: 'suite'
      ...
    1..5
ok 15 - Evidence Bundle Schema - Phase-7R Sections
  ---
  duration_ms: 103.572324
  type: 'suite'
  ...
# {"level":30,"time":1768710935291,"pid":30569,"hostname":"DESKTOP-VV0116A","name":"EvidenceExportService","filepath":"/tmp/test_evidence/batch_mkj8to17_7255fa1a.json","hashFilepath":"/tmp/test_evidence/batch_mkj8to17_7255fa1a.json.sha256","msg":"Batch written to filesystem"}
# Subtest: EvidenceExportService
    # Subtest: getHighWaterMarks
        # Subtest: should fetch marks from DB using coalesced max IDs
        ok 1 - should fetch marks from DB using coalesced max IDs
          ---
          duration_ms: 28.54679
          ...
        1..1
    ok 1 - getHighWaterMarks
      ---
      duration_ms: 30.531401
      type: 'suite'
      ...
    # Subtest: getLastExportState
        # Subtest: should return null if no logs exist
        ok 1 - should return null if no logs exist
          ---
          duration_ms: 13.502226
          ...
        # Subtest: should return last batch state if exists
        ok 2 - should return last batch state if exists
          ---
          duration_ms: 1.62087
          ...
        1..2
    ok 2 - getLastExportState
      ---
      duration_ms: 15.701748
      type: 'suite'
      ...
    # Subtest: exportBatch
        # Subtest: should orchestrate full export flow (fetch -> hash -> write -> log)
        ok 1 - should orchestrate full export flow (fetch -> hash -> write -> log)
          ---
          duration_ms: 31.174627
          ...
        # Subtest: should link to previous batch ID when fromMarks provided
        ok 2 - should link to previous batch ID when fromMarks provided
          ---
          duration_ms: 15.224225
          ...
        # Subtest: should rollback and throw on error
        ok 3 - should rollback and throw on error
          ---
          duration_ms: 16.336539
          ...
        1..3
    ok 3 - exportBatch
      ---
      duration_ms: 63.703594
      type: 'suite'
      ...
    # Subtest: Hashing Logic (Deterministic)
        # Subtest: should produce consistent hash for same data
        ok 1 - should produce consistent hash for same data
          ---
          duration_ms: 112.790137
          ...
        1..1
    ok 4 - Hashing Logic (Deterministic)
      ---
      duration_ms: 113.203188
      type: 'suite'
      ...
    1..4
ok 16 - EvidenceExportService
  ---
  duration_ms: 225.535987
  type: 'suite'
  ...
# {"level":30,"time":1768710935293,"pid":30569,"hostname":"DESKTOP-VV0116A","name":"EvidenceExportService","batchId":"batch_mkj8to17_7255fa1a","recordCounts":{"ingress":1,"outbox":0,"ledger":0},"batchHash":"719a077e6ef986793d2c831bb1116f6818fd68c6197c5f4e9f6222bffabbfbde","msg":"Evidence batch exported successfully"}
# {"level":30,"time":1768710935295,"pid":30569,"hostname":"DESKTOP-VV0116A","name":"EvidenceExportService","filepath":"/tmp/test_evidence/batch_mkj8to1q_9731f70c.json","hashFilepath":"/tmp/test_evidence/batch_mkj8to1q_9731f70c.json.sha256","msg":"Batch written to filesystem"}
# {"level":30,"time":1768710935296,"pid":30569,"hostname":"DESKTOP-VV0116A","name":"EvidenceExportService","batchId":"batch_mkj8to1q_9731f70c","recordCounts":{"ingress":0,"outbox":0,"ledger":0},"batchHash":"0a3609fc0616fe5603afe4389ba9ad4aebe86d751f7622204d4cb9299eb2a5fa","msg":"Evidence batch exported successfully"}
# {"level":50,"time":1768710935323,"pid":30569,"hostname":"DESKTOP-VV0116A","name":"EvidenceExportService","error":{},"batchId":"batch_mkj8to26_b7e3fe74","msg":"Evidence batch export failed"}
# {"level":30,"time":1768710935438,"pid":30569,"hostname":"DESKTOP-VV0116A","name":"EvidenceExportService","filepath":"/tmp/test_evidence/batch_mkj8to2n_0ec5b0e5.json","hashFilepath":"/tmp/test_evidence/batch_mkj8to2n_0ec5b0e5.json.sha256","msg":"Batch written to filesystem"}
# {"level":30,"time":1768710935438,"pid":30569,"hostname":"DESKTOP-VV0116A","name":"EvidenceExportService","batchId":"batch_mkj8to2n_0ec5b0e5","recordCounts":{"ingress":2,"outbox":0,"ledger":0},"batchHash":"d4c391941bd26c7b235dc0061a33c4f2a347a070e60cf94448ceae01ac77b18d","msg":"Evidence batch exported successfully"}
# {"level":30,"time":1768710943004,"system":"symphony","msg":"BC/DR: Commencing Health Verification..."}
# Subtest: HealthVerifier
    # Subtest: should detect missing audit file
    ok 1 - should detect missing audit file
      ---
      duration_ms: 4.065451
      ...
    1..1
ok 17 - HealthVerifier
  ---
  duration_ms: 826.943222
  type: 'suite'
  ...
# {"level":30,"time":1768710943005,"system":"symphony","msg":"BC/DR: Policy parity verified."}
# {"level":30,"time":1768710943005,"system":"symphony","msg":"BC/DR: Guardrail reconciliation complete."}
# Subtest: Identity Schema Validation (Strict)
    # Subtest: should ACCEPT a valid user envelope with trustTier: "user"
    ok 1 - should ACCEPT a valid user envelope with trustTier: "user"
      ---
      duration_ms: 11.887787
      ...
    # Subtest: should REJECT a user envelope with trustTier: "external"
    ok 2 - should REJECT a user envelope with trustTier: "external"
      ---
      duration_ms: 2.000136
      ...
    # Subtest: should REJECT a service envelope without certFingerprint
    ok 3 - should REJECT a service envelope without certFingerprint
      ---
      duration_ms: 2.351865
      ...
    1..3
ok 18 - Identity Schema Validation (Strict)
  ---
  duration_ms: 18.395746
  type: 'suite'
  ...
# DEBUG: IngressAttestationMiddleware.spec.ts loaded
# DEBUG: beforeEach started
# DEBUG: service instantiated
# DEBUG: test1 started
# {"level":30,"time":1768710951741,"pid":30676,"hostname":"DESKTOP-VV0116A","name":"IngressAttestation","event":"INGRESS_ATTESTED","attestationId":"att-1","requestId":"req-1","recordHash":"new-hash-456..."}
# DEBUG: attest called
# DEBUG: test1 finished
# DEBUG: beforeEach started
# DEBUG: service instantiated
# DEBUG: test2 started
# DEBUG: test2 finished
# DEBUG: beforeEach started
# DEBUG: service instantiated
# DEBUG: test3 started
# DEBUG: test3 finished
# DEBUG: beforeEach started
# DEBUG: service instantiated
# DEBUG: test4 started
# DEBUG: test4 finished
# DEBUG: beforeEach started
# DEBUG: service instantiated
# DEBUG: test5 started
# DEBUG: test5 finished
# Subtest: IngressAttestationService
    # Subtest: attest()
        # Subtest: should validate and insert attestation record
        ok 1 - should validate and insert attestation record
          ---
          duration_ms: 15.344669
          ...
        # Subtest: should throw InvalidEnvelopeError for missing fields
        ok 2 - should throw InvalidEnvelopeError for missing fields
          ---
          duration_ms: 11.094691
          ...
        # Subtest: should release client on error
        ok 3 - should release client on error
          ---
          duration_ms: 5.041339
          ...
        1..3
    ok 1 - attest()
      ---
      duration_ms: 33.488887
      type: 'suite'
      ...
    # Subtest: markExecutionStarted()
        # Subtest: should update execution_started with attestedAt pruning
        ok 1 - should update execution_started with attestedAt pruning
          ---
          duration_ms: 14.824667
          ...
        1..1
    ok 2 - markExecutionStarted()
      ---
      duration_ms: 15.263182
      type: 'suite'
      ...
    # Subtest: markExecutionCompleted()
        # Subtest: should update execution_completed with attestedAt pruning
        ok 1 - should update execution_completed with attestedAt pruning
          ---
          duration_ms: 3.975532
          ...
        1..1
    ok 3 - markExecutionCompleted()
      ---
      duration_ms: 4.839016
      type: 'suite'
      ...
    1..3
ok 19 - IngressAttestationService
  ---
  duration_ms: 54.842579
  type: 'suite'
  ...
# {"level":50,"time":1768710951761,"pid":30676,"hostname":"DESKTOP-VV0116A","name":"IngressAttestation","error":"DB Error","msg":"Attestation failed"}
# Subtest: InstructionStateClient
    # Subtest: State Machine Validation
        # Subtest: should identify COMPLETED as terminal
        ok 1 - should identify COMPLETED as terminal
          ---
          duration_ms: 1.518981
          ...
        # Subtest: should identify FAILED as terminal
        ok 2 - should identify FAILED as terminal
          ---
          duration_ms: 0.416504
          ...
        # Subtest: should identify EXECUTING as non-terminal
        ok 3 - should identify EXECUTING as non-terminal
          ---
          duration_ms: 1.56092
          ...
        # Subtest: should have exactly 2 terminal states
        ok 4 - should have exactly 2 terminal states
          ---
          duration_ms: 0.467907
          ...
        1..4
    ok 1 - State Machine Validation
      ---
      duration_ms: 5.678745
      type: 'suite'
      ...
    # Subtest: API Integration Contract
        # Subtest: should use correct state query endpoint format
        ok 1 - should use correct state query endpoint format
          ---
          duration_ms: 0.443999
          ...
        # Subtest: should use correct transition endpoint format
        ok 2 - should use correct transition endpoint format
          ---
          duration_ms: 2.30238
          ...
        1..2
    ok 2 - API Integration Contract
      ---
      duration_ms: 3.745651
      type: 'suite'
      ...
    # Subtest: Transition Request Validation
        # Subtest: should only allow COMPLETED or FAILED as target states
        ok 1 - should only allow COMPLETED or FAILED as target states
          ---
          duration_ms: 0.742058
          ...
        1..1
    ok 3 - Transition Request Validation
      ---
      duration_ms: 1.233574
      type: 'suite'
      ...
    1..3
ok 20 - InstructionStateClient
  ---
  duration_ms: 15.150062
  type: 'suite'
  ...
# {"level":30,"time":1768710961347,"system":"symphony","keyCount":1,"msg":"JWKS loaded successfully"}
# Subtest: JWKS Loader (Security Hardened)
    # Subtest: should load JWKS from default path if exists
    ok 1 - should load JWKS from default path if exists
      ---
      duration_ms: 10.336557
      ...
    # Subtest: should FAIL CLOSED in PRODUCTION if JWKS missing
    ok 2 - should FAIL CLOSED in PRODUCTION if JWKS missing
      ---
      duration_ms: 1.656524
      ...
    # Subtest: should use fallback in DEVELOPMENT if JWKS missing
    ok 3 - should use fallback in DEVELOPMENT if JWKS missing
      ---
      duration_ms: 2.683194
      ...
    # Subtest: should REJECT path traversal via JWKS_PATH
    ok 4 - should REJECT path traversal via JWKS_PATH
      ---
      duration_ms: 0.733649
      ...
    # Subtest: should refresh cache after TTL
    ok 5 - should refresh cache after TTL
      ---
      duration_ms: 1.782675
      ...
    1..5
ok 21 - JWKS Loader (Security Hardened)
  ---
  duration_ms: 57.444194
  type: 'suite'
  ...
# {"level":40,"time":1768710961353,"system":"symphony","path":"/home/mwiza/workspaces/Symphony/non-existent-jwks.json","msg":"JWKS file not found - using development fallback"}
# {"level":30,"time":1768710961357,"system":"symphony","keyCount":1,"msg":"JWKS loaded successfully"}
# {"level":30,"time":1768710961357,"system":"symphony","keyCount":1,"msg":"JWKS loaded successfully"}
# {"level":30,"time":1768710969884,"system":"symphony","keyCount":1,"msg":"JWKS loaded successfully"}
# Subtest: jwtToMtlsBridge
    # Subtest: should bridge valid CLIENT JWT
# {"level":30,"time":1768710969915,"system":"symphony","type":"IDENTITY_BRIDGE","requestId":"d8f5af8f-3f37-4165-b6a4-89833d6b71ff","action":"TERMINATE_JWT_AND_BRIDGE_CLIENT","subjectId":"user-1","trustTier":"external","msg":"Bridged external client identity"}
    ok 1 - should bridge valid CLIENT JWT
      ---
      duration_ms: 75.274005
      ...
    # Subtest: should bridge valid TENANT-ANCHORED USER JWT
# {"level":30,"time":1768710969931,"system":"symphony","type":"IDENTITY_BRIDGE","requestId":"77b1b5d5-599a-4c91-a69f-689aee6a33b8","action":"TERMINATE_JWT_AND_BRIDGE_USER","subjectId":"user-alice","participantId":"tenant-A","trustTier":"user","msg":"Bridged tenant-anchored user identity"}
    ok 2 - should bridge valid TENANT-ANCHORED USER JWT
      ---
      duration_ms: 14.887475
      ...
# {"level":40,"time":1768710969949,"system":"symphony","error":"signature verification failed","msg":"JWT verification failed"}
    # Subtest: should reject invalid signature
    ok 3 - should reject invalid signature
      ---
      duration_ms: 22.686905
      ...
# {"level":40,"time":1768710969967,"system":"symphony","error":"\\"exp\\" claim timestamp check failed","msg":"JWT verification failed"}
    # Subtest: should reject expired token
    ok 4 - should reject expired token
      ---
      duration_ms: 20.701188
      ...
# {"level":40,"time":1768710969987,"system":"symphony","error":"unexpected \\"aud\\" claim value","msg":"JWT verification failed"}
    # Subtest: should reject wrong audience
    ok 5 - should reject wrong audience
      ---
      duration_ms: 15.569472
      ...
    1..5
ok 22 - jwtToMtlsBridge
  ---
  duration_ms: 244.549681
  type: 'suite'
  ...
# Subtest: SymphonyKeyManager (SEC-FIX)
    # Subtest: KMS_KEY_REF Enforcement
        # Subtest: should throw if KMS_KEY_REF is missing
        ok 1 - should throw if KMS_KEY_REF is missing
          ---
          duration_ms: 1895.562047
          ...
        # Subtest: should throw if KMS_KEY_REF is empty string
        ok 2 - should throw if KMS_KEY_REF is empty string
          ---
          duration_ms: 32.362007
          ...
        # Subtest: should NOT use alias/symphony-root fallback
        ok 3 - should NOT use alias/symphony-root fallback
          ---
          duration_ms: 37.590404
          ...
# {"level":50,"time":1768710975128,"system":"symphony","error":"Region is missing","operation":"deriveKey","keyRef":"arn:aws:kms:us-east-...","msg":"KMS key derivation failed"}
        # Subtest: should use KMS_KEY_REF when present
        ok 4 - should use KMS_KEY_REF when present
          ---
          duration_ms: 39.013068
          ...
        1..4
    ok 1 - KMS_KEY_REF Enforcement
      ---
      duration_ms: 2018.010396
      type: 'suite'
      ...
    # Subtest: Logging Correctness
        # Subtest: should log operation as deriveKey (not decrypt)
        ok 1 - should log operation as deriveKey (not decrypt)
          ---
          duration_ms: 42.623263
          ...
        1..1
    ok 2 - Logging Correctness
      ---
      duration_ms: 43.282786
      type: 'suite'
      ...
    1..2
ok 23 - SymphonyKeyManager (SEC-FIX)
  ---
  duration_ms: 2062.881951
  type: 'suite'
  ...
# Subtest: LedgerReplayEngine
    # Subtest: Balance Reconstruction
        # Subtest: should correctly sum debits and credits per account
        ok 1 - should correctly sum debits and credits per account
          ---
          duration_ms: 2.186485
          ...
        # Subtest: should calculate correct net balance
        ok 2 - should calculate correct net balance
          ---
          duration_ms: 3.136267
          ...
        # Subtest: should handle empty ledger
        ok 3 - should handle empty ledger
          ---
          duration_ms: 8.410875
          ...
        # Subtest: should handle multiple currencies for same account
        ok 4 - should handle multiple currencies for same account
          ---
          duration_ms: 1.034009
          ...
        1..4
    ok 1 - Balance Reconstruction
      ---
      duration_ms: 25.19041
      type: 'suite'
      ...
    # Subtest: Deterministic Hashing
        # Subtest: should produce consistent hash for same input data
        ok 1 - should produce consistent hash for same input data
          ---
          duration_ms: 1.499598
          ...
        # Subtest: should produce different hash for different input data
        ok 2 - should produce different hash for different input data
          ---
          duration_ms: 0.58927
          ...
        1..2
    ok 2 - Deterministic Hashing
      ---
      duration_ms: 2.525634
      type: 'suite'
      ...
    # Subtest: Replay Reproducibility
        # Subtest: should produce identical results on repeated runs with same input
        ok 1 - should produce identical results on repeated runs with same input
          ---
          duration_ms: 1.914592
          ...
        1..1
    ok 3 - Replay Reproducibility
      ---
      duration_ms: 3.623322
      type: 'suite'
      ...
    1..3
ok 24 - LedgerReplayEngine
  ---
  duration_ms: 43.658131
  type: 'suite'
  ...
# Subtest: ReplayVerificationReport
    # Subtest: Balance Comparison
        # Subtest: should detect matching balances
        ok 1 - should detect matching balances
          ---
          duration_ms: 0.553597
          ...
        # Subtest: should detect deviations
        ok 2 - should detect deviations
          ---
          duration_ms: 0.537038
          ...
        # Subtest: should tolerate rounding within 1 cent
        ok 3 - should tolerate rounding within 1 cent
          ---
          duration_ms: 0.540105
          ...
        1..3
    ok 1 - Balance Comparison
      ---
      duration_ms: 2.111254
      type: 'suite'
      ...
    # Subtest: Report Status
        # Subtest: should return PASS when all balances match
        ok 1 - should return PASS when all balances match
          ---
          duration_ms: 0.459252
          ...
        # Subtest: should return WARNING for 1-3 deviations
        ok 2 - should return WARNING for 1-3 deviations
          ---
          duration_ms: 0.552677
          ...
        # Subtest: should return FAIL for >3 deviations
        ok 3 - should return FAIL for >3 deviations
          ---
          duration_ms: 0.592235
          ...
        1..3
    ok 2 - Report Status
      ---
      duration_ms: 2.198239
      type: 'suite'
      ...
    # Subtest: Report Hashing
        # Subtest: should include hash of input datasets
        ok 1 - should include hash of input datasets
          ---
          duration_ms: 0.702729
          ...
        # Subtest: should include hash of final report
        ok 2 - should include hash of final report
          ---
          duration_ms: 0.601434
          ...
        1..2
    ok 3 - Report Hashing
      ---
      duration_ms: 1.695851
      type: 'suite'
      ...
    1..3
ok 25 - ReplayVerificationReport
  ---
  duration_ms: 6.743337
  type: 'suite'
  ...
# Subtest: MonotonicIdGenerator
    # Subtest: ID Generation
        # Subtest: should generate unique IDs
        ok 1 - should generate unique IDs
          ---
          duration_ms: 15.690763
          ...
        # Subtest: should generate monotonically increasing IDs
        ok 2 - should generate monotonically increasing IDs
          ---
          duration_ms: 0.97951
          ...
        # Subtest: should generate IDs as strings
        ok 3 - should generate IDs as strings
          ---
          duration_ms: 19.122991
          ...
        1..3
    ok 1 - ID Generation
      ---
      duration_ms: 37.564384
      type: 'suite'
      ...
    # Subtest: Worker ID Validation
        # Subtest: should accept valid worker IDs (0-1023)
        ok 1 - should accept valid worker IDs (0-1023)
          ---
          duration_ms: 1.242067
          ...
        # Subtest: should reject invalid worker IDs
        ok 2 - should reject invalid worker IDs
          ---
          duration_ms: 13.415743
          ...
        1..2
    ok 2 - Worker ID Validation
      ---
      duration_ms: 15.236263
      type: 'suite'
      ...
    # Subtest: Clock-Safety: Wait State
        # Subtest: should not be in wait state initially
        ok 1 - should not be in wait state initially
          ---
          duration_ms: 0.784437
          ...
        # Subtest: should handle sequence overflow within same millisecond
        ok 2 - should handle sequence overflow within same millisecond
          ---
          duration_ms: 2.093785
          ...
        1..2
    ok 3 - Clock-Safety: Wait State
      ---
      duration_ms: 6.516435
      type: 'suite'
      ...
    # Subtest: Factory Function
        # Subtest: should create generator with specified worker ID
        ok 1 - should create generator with specified worker ID
          ---
          duration_ms: 0.644117
          ...
        1..1
    ok 4 - Factory Function
      ---
      duration_ms: 11.625126
      type: 'suite'
      ...
    1..4
ok 26 - MonotonicIdGenerator
  ---
  duration_ms: 72.799703
  type: 'suite'
  ...
# Subtest: ClockMovedBackwardsError
    # Subtest: should have correct error properties
    ok 1 - should have correct error properties
      ---
      duration_ms: 0.62856
      ...
    1..1
ok 27 - ClockMovedBackwardsError
  ---
  duration_ms: 1.356223
  type: 'suite'
  ...
# Subtest: MtlsGate
    # Subtest: getServerOptions
        # Subtest: should return hardened server options with rejectUnauthorized=true
        ok 1 - should return hardened server options with rejectUnauthorized=true
          ---
          duration_ms: 28.482309
          ...
        # Subtest: should read from environment variables
        ok 2 - should read from environment variables
          ---
          duration_ms: 0.579734
          ...
        1..2
    ok 1 - getServerOptions
      ---
      duration_ms: 30.904154
      type: 'suite'
      ...
    # Subtest: getAgent
        # Subtest: should return HTTPS agent with rejectUnauthorized=true
        ok 1 - should return HTTPS agent with rejectUnauthorized=true
          ---
          duration_ms: 0.740644
          ...
        1..1
    ok 2 - getAgent
      ---
      duration_ms: 1.198072
      type: 'suite'
      ...
    1..2
ok 28 - MtlsGate
  ---
  duration_ms: 186.37751
  type: 'suite'
  ...
# {"level":30,"time":1768710987082,"pid":30866,"hostname":"DESKTOP-VV0116A","name":"OutboxDispatch","event":"DISPATCH_QUEUED","outboxId":"outbox-1","sequenceId":"1234567890","participantId":"part-1","eventType":"PAYMENT"}
# Subtest: OutboxDispatchService
    # Subtest: atomic dispatch
        # Subtest: should dispatch to outbox and ledger in same transaction
        not ok 1 - should dispatch to outbox and ledger in same transaction
          ---
          duration_ms: 30.70384
          location: '/home/mwiza/workspaces/Symphony/tests/unit/OutboxDispatchService.spec.ts:34:9'
          failureType: 'testCodeFailure'
          error: "Cannot read properties of undefined (reading 'arguments')"
          code: 'ERR_TEST_FAILURE'
          name: 'TypeError'
          stack: |-
            TestContext.<anonymous> (file:///home/mwiza/workspaces/Symphony/tests/unit/OutboxDispatchService.spec.ts:70:40)
            async Test.run (node:internal/test_runner/test:797:9)
            async Promise.all (index 0)
            async Suite.run (node:internal/test_runner/test:1135:7)
            async Promise.all (index 0)
            async Suite.run (node:internal/test_runner/test:1135:7)
            async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: should rollback on error
        not ok 2 - should rollback on error
          ---
          duration_ms: 10.052453
          location: '/home/mwiza/workspaces/Symphony/tests/unit/OutboxDispatchService.spec.ts:78:9'
          failureType: 'testCodeFailure'
          error: |-
            Expected values to be strictly equal:
            + actual - expected
            
            + 'ROLLBACK'
            - 'COMMIT'
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: 'COMMIT'
          actual: 'ROLLBACK'
          operator: 'strictEqual'
          stack: |-
            TestContext.<anonymous> (file:///home/mwiza/workspaces/Symphony/tests/unit/OutboxDispatchService.spec.ts:94:20)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        1..2
    not ok 1 - atomic dispatch
      ---
      duration_ms: 46.231187
      type: 'suite'
      location: '/home/mwiza/workspaces/Symphony/tests/unit/OutboxDispatchService.spec.ts:32:5'
      failureType: 'subtestsFailed'
      error: '2 subtests failed'
      code: 'ERR_TEST_FAILURE'
      stack: |-
        async Promise.all (index 0)
      ...
    # Subtest: idempotency
        # Subtest: should return existing record on duplicate idempotency key
        ok 1 - should return existing record on duplicate idempotency key
          ---
          duration_ms: 5.465816
          ...
        # Subtest: should handle concurrent insert race condition
        ok 2 - should handle concurrent insert race condition
          ---
          duration_ms: 1.226442
          ...
        1..2
    ok 2 - idempotency
      ---
      duration_ms: 7.504499
      type: 'suite'
      ...
    1..2
not ok 29 - OutboxDispatchService
  ---
  duration_ms: 59.294776
  type: 'suite'
  location: '/home/mwiza/workspaces/Symphony/tests/unit/OutboxDispatchService.spec.ts:12:1'
  failureType: 'subtestsFailed'
  error: '1 subtest failed'
  code: 'ERR_TEST_FAILURE'
  ...
# {"level":30,"time":1768710987083,"pid":30866,"hostname":"DESKTOP-VV0116A","name":"OutboxDispatch","event":"LEDGER_AND_DISPATCH_COMMITTED","outboxId":"outbox-1","ledgerEntries":1}
# {"level":50,"time":1768710987100,"pid":30866,"hostname":"DESKTOP-VV0116A","name":"OutboxDispatch","error":"DB Error","msg":"Dispatch failed"}
# {"level":30,"time":1768710987115,"pid":30866,"hostname":"DESKTOP-VV0116A","name":"OutboxDispatch","event":"DUPLICATE_DISPATCH","idempotencyKey":"idem-1","existingId":"existing-1","existingStatus":"PENDING"}
# {"level":30,"time":1768710992593,"pid":30889,"hostname":"DESKTOP-VV0116A","name":"OutboxRelayer","correlationId":"uuid-1","railReference":"ref-123","msg":"Dispatch successful"}
# Subtest: OutboxRelayer
    # Subtest: poll() -> fetchNextBatch()
        # Subtest: should process available records
        ok 1 - should process available records
          ---
          duration_ms: 12.915293
          ...
        1..1
    ok 1 - poll() -> fetchNextBatch()
      ---
      duration_ms: 15.576421
      type: 'suite'
      ...
    # Subtest: processRecord()
        # Subtest: should dispatch to rail and mark success
        ok 1 - should dispatch to rail and mark success
          ---
          duration_ms: 3.178261
          ...
        # Subtest: should handle transient errors by marking RECOVERING
        ok 2 - should handle transient errors by marking RECOVERING
          ---
          duration_ms: 11.654156
          ...
        # Subtest: should dlq after max retries
        ok 3 - should dlq after max retries
          ---
          duration_ms: 1.120689
          ...
        1..3
    ok 2 - processRecord()
      ---
      duration_ms: 16.704087
      type: 'suite'
      ...
    1..2
ok 30 - OutboxRelayer
  ---
  duration_ms: 46.119027
  type: 'suite'
  ...
# {"level":50,"time":1768710992606,"pid":30889,"hostname":"DESKTOP-VV0116A","name":"OutboxRelayer","correlationId":"uuid-1","error":"ECONNRESET: Connection reset","msg":"Dispatch failure"}
# {"level":40,"time":1768710992607,"pid":30889,"hostname":"DESKTOP-VV0116A","name":"OutboxRelayer","correlationId":"uuid-1","retryCount":5,"msg":"Moved to DLQ"}
# {"level":30,"time":1768710996511,"system":"symphony","msg":"Configuration guard passed."}
# Subtest: validatePolicyVersion
    # Subtest: should accept matching policy version
    ok 1 - should accept matching policy version
      ---
      duration_ms: 13.309583
      ...
    # Subtest: should reject mismatched policy version
    ok 2 - should reject mismatched policy version
      ---
      duration_ms: 8.006926
      ...
    # Subtest: should reject invalid policy version format
    ok 3 - should reject invalid policy version format
      ---
      duration_ms: 0.722433
      ...
    1..3
ok 31 - validatePolicyVersion
  ---
  duration_ms: 2867.508783
  type: 'suite'
  ...
# {"level":30,"time":1768711001302,"pid":30930,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_STATE_REFRESHED","activeVersion":"v1.2.3","acceptedCount":2,"graceCount":1}
# Subtest: PolicyConsistencyService
    # Subtest: getGlobalPolicyState
        # Subtest: should load and cache policy state from database
        ok 1 - should load and cache policy state from database
          ---
          duration_ms: 19.972941
          ...
        1..1
    ok 1 - getGlobalPolicyState
      ---
      duration_ms: 21.315037
      type: 'suite'
      ...
    # Subtest: validatePolicyClaims
        # Subtest: should validate a valid token with active version
        ok 1 - should validate a valid token with active version
          ---
          duration_ms: 16.847989
          ...
        # Subtest: should allow token in grace period but flag for re-auth
        ok 2 - should allow token in grace period but flag for re-auth
          ---
          duration_ms: 2.001787
          ...
        # Subtest: should reject retired or unknown versions
        ok 3 - should reject retired or unknown versions
          ---
          duration_ms: 30.718712
          ...
        # Subtest: should reject tokens with invalid scope
        ok 4 - should reject tokens with invalid scope
          ---
          duration_ms: 14.451468
          ...
        # Subtest: should reject expired tokens
        ok 5 - should reject expired tokens
          ---
          duration_ms: 2.602443
          ...
        1..5
    ok 2 - validatePolicyClaims
      ---
      duration_ms: 67.68933
      type: 'suite'
      ...
    # Subtest: isOperationAllowed
        # Subtest: should allow authorized operations within limits
        ok 1 - should allow authorized operations within limits
          ---
          duration_ms: 3.027895
          ...
        # Subtest: should deny unauthorized operations
        ok 2 - should deny unauthorized operations
          ---
          duration_ms: 13.172309
          ...
        # Subtest: should deny transaction amounts exceeding limit
        ok 3 - should deny transaction amounts exceeding limit
          ---
          duration_ms: 1.696506
          ...
        1..3
    ok 3 - isOperationAllowed
      ---
      duration_ms: 31.308162
      type: 'suite'
      ...
    1..3
ok 32 - PolicyConsistencyService
  ---
  duration_ms: 134.807122
  type: 'suite'
  ...
# {"level":30,"time":1768711001311,"pid":30930,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_CACHE_INVALIDATED"}
# {"level":30,"time":1768711001329,"pid":30930,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_STATE_REFRESHED","activeVersion":"v1.2.3","acceptedCount":2,"graceCount":1}
# {"level":30,"time":1768711001343,"pid":30930,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_CACHE_INVALIDATED"}
# {"level":30,"time":1768711001345,"pid":30930,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_STATE_REFRESHED","activeVersion":"v1.2.3","acceptedCount":2,"graceCount":1}
# {"level":30,"time":1768711001345,"pid":30930,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_VERSION_IN_GRACE","tokenVersion":"v1.2.2","activeVersion":"v1.2.3","participantId":"user-123"}
# {"level":30,"time":1768711001345,"pid":30930,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_CACHE_INVALIDATED"}
# {"level":30,"time":1768711001359,"pid":30930,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_STATE_REFRESHED","activeVersion":"v1.2.3","acceptedCount":2,"graceCount":1}
# {"level":40,"time":1768711001360,"pid":30930,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_VERSION_REJECTED","tokenVersion":"v1.0.0","activeVersion":"v1.2.3","tokenHash":"2485f4d55aae6c5b","activeHash":"e3cad1a6f905017f","participantId":"user-123","acceptedVersions":["v1.2.3","v1.2.2"]}
# {"level":30,"time":1768711001375,"pid":30930,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_CACHE_INVALIDATED"}
# {"level":30,"time":1768711001378,"pid":30930,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_STATE_REFRESHED","activeVersion":"v1.2.3","acceptedCount":2,"graceCount":1}
# {"level":30,"time":1768711001391,"pid":30930,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_CACHE_INVALIDATED"}
# {"level":30,"time":1768711001393,"pid":30930,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_STATE_REFRESHED","activeVersion":"v1.2.3","acceptedCount":2,"graceCount":1}
# {"level":30,"time":1768711001393,"pid":30930,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_CACHE_INVALIDATED"}
# {"level":30,"time":1768711001408,"pid":30930,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_STATE_REFRESHED","activeVersion":"v1.2.3","acceptedCount":2,"graceCount":1}
# {"level":30,"time":1768711001409,"pid":30930,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_CACHE_INVALIDATED"}
# {"level":30,"time":1768711001423,"pid":30930,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_STATE_REFRESHED","activeVersion":"v1.2.3","acceptedCount":2,"graceCount":1}
# {"level":40,"time":1768711001423,"pid":30930,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"OPERATION_NOT_ALLOWED","operation":"REFUND","participantId":"user-123","scope":"TIER_1"}
# {"level":30,"time":1768711001423,"pid":30930,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_CACHE_INVALIDATED"}
# {"level":30,"time":1768711001425,"pid":30930,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_STATE_REFRESHED","activeVersion":"v1.2.3","acceptedCount":2,"graceCount":1}
# {"level":40,"time":1768711001425,"pid":30930,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"AMOUNT_EXCEEDS_LIMIT","amount":1500,"limit":1000,"participantId":"user-123"}
# {"level":30,"time":1768711001425,"pid":30930,"hostname":"DESKTOP-VV0116A","name":"PolicyConsistency","event":"POLICY_CACHE_INVALIDATED"}
# Subtest: Log Redaction
    # Subtest: should redact sensitive keys in objects
    ok 1 - should redact sensitive keys in objects
      ---
      duration_ms: 20.960117
      ...
    1..1
ok 33 - Log Redaction
  ---
  duration_ms: 33.823578
  type: 'suite'
  ...
# Subtest: RequestContext
    # Subtest: should throw when accessing context outside run()
    ok 1 - should throw when accessing context outside run()
      ---
      duration_ms: 15.902745
      ...
    # Subtest: should return context inside run()
    ok 2 - should return context inside run()
      ---
      duration_ms: 12.675677
      ...
    # Subtest: should maintain isolation between concurrent async requests
    ok 3 - should maintain isolation between concurrent async requests
      ---
      duration_ms: 54.538576
      ...
    # Subtest: should forbid set() usage
    ok 4 - should forbid set() usage
      ---
      duration_ms: 1.508442
      ...
    1..4
ok 34 - RequestContext
  ---
  duration_ms: 86.994497
  type: 'suite'
  ...
# Subtest: ParticipantResolver
    # Subtest: Resolution Context Validation
        # Subtest: should require requestId in context
        ok 1 - should require requestId in context
          ---
          duration_ms: 1.944892
          ...
        1..1
    ok 1 - Resolution Context Validation
      ---
      duration_ms: 3.09078
      type: 'suite'
      ...
    # Subtest: Resolution Failure Reasons
        # Subtest: should define all expected failure reasons
        ok 1 - should define all expected failure reasons
          ---
          duration_ms: 0.786559
          ...
        # Subtest: should include CERTIFICATE_REVOKED for trust fabric failures
        ok 2 - should include CERTIFICATE_REVOKED for trust fabric failures
          ---
          duration_ms: 0.467854
          ...
        # Subtest: should include FINGERPRINT_NOT_FOUND for unknown certs
        ok 3 - should include FINGERPRINT_NOT_FOUND for unknown certs
          ---
          duration_ms: 0.328363
          ...
        # Subtest: should include PARTICIPANT_SUSPENDED for inactive participants
        ok 4 - should include PARTICIPANT_SUSPENDED for inactive participants
          ---
          duration_ms: 0.449234
          ...
        1..4
    ok 2 - Resolution Failure Reasons
      ---
      duration_ms: 3.094663
      type: 'suite'
      ...
    # Subtest: Resolution Flow Steps
        # Subtest: should have 5 resolution steps
        ok 1 - should have 5 resolution steps
          ---
          duration_ms: 0.648264
          ...
        # Subtest: should validate certificate before participant lookup
        ok 2 - should validate certificate before participant lookup
          ---
          duration_ms: 0.427231
          ...
        1..2
    ok 3 - Resolution Flow Steps
      ---
      duration_ms: 1.93165
      type: 'suite'
      ...
    1..3
ok 35 - ParticipantResolver
  ---
  duration_ms: 11.215042
  type: 'suite'
  ...
# {"level":50,"time":1768711011389,"system":"symphony","incidentId":"1df95040-1134-4b0b-9f49-b3efc9bf5209","category":"SEC","internalDetails":{"secret":"[REDACTED]"},"stack":"Error: Test error\\n    at TestContext.<anonymous> (file:///home/mwiza/workspaces/Symphony/tests/unit/Sanitizer.spec.ts:31:23)\\n    at Test.runInAsyncScope (node:async_hooks:206:9)\\n    at Test.run (node:internal/test_runner/test:796:25)\\n    at async Promise.all (index 0)\\n    at async Suite.run (node:internal/test_runner/test:1135:7)\\n    at async Test.processPendingSubtests (node:internal/test_runner/test:526:7)","msg":"Test error"}
# Subtest: ErrorSanitizer
    # Subtest: should create SymphonyError with incidentId
    ok 1 - should create SymphonyError with incidentId
      ---
      duration_ms: 5.335029
      ...
    # Subtest: should sanitize raw errors into SymphonyError
    ok 2 - should sanitize raw errors into SymphonyError
      ---
      duration_ms: 1.125029
      ...
    # Subtest: should pass through existing SymphonyError unchanged
    ok 3 - should pass through existing SymphonyError unchanged
      ---
      duration_ms: 10.017541
      ...
    1..3
ok 36 - ErrorSanitizer
  ---
  duration_ms: 853.160632
  type: 'suite'
  ...
# {"level":50,"time":1768711011393,"system":"symphony","incidentId":"b5b9c9e0-7efa-4021-9ae6-6fb5087a7280","category":"OPS","internalDetails":{"originalError":"Database connection failed: password=secret123","stack":"Error: Database connection failed: password=secret123\\n    at TestContext.<anonymous> (file:///home/mwiza/workspaces/Symphony/tests/unit/Sanitizer.spec.ts:38:26)\\n    at Test.runInAsyncScope (node:async_hooks:206:9)\\n    at Test.run (node:internal/test_runner/test:796:25)\\n    at async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)","context":"db-op"},"stack":"Error: An internal system error occurred. Please contact support with ID: db-op\\n    at Object.sanitize (file:///home/mwiza/workspaces/Symphony/libs/errors/sanitizer.ts:60:16)\\n    at TestContext.<anonymous> (file:///home/mwiza/workspaces/Symphony/tests/unit/Sanitizer.spec.ts:39:42)\\n    at Test.runInAsyncScope (node:async_hooks:206:9)\\n    at Test.run (node:internal/test_runner/test:796:25)\\n    at async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)","msg":"An internal system error occurred. Please contact support with ID: db-op"}
# {"level":50,"time":1768711011403,"system":"symphony","incidentId":"285811fc-5265-4493-b6cd-c7ef59a1d201","category":"OPS","internalDetails":{"data":"test"},"stack":"Error: Original\\n    at TestContext.<anonymous> (file:///home/mwiza/workspaces/Symphony/tests/unit/Sanitizer.spec.ts:46:26)\\n    at Test.runInAsyncScope (node:async_hooks:206:9)\\n    at Test.run (node:internal/test_runner/test:796:25)\\n    at async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)","msg":"Original"}
# Subtest: ShortLivedCertificateManager
    # Subtest: Certificate Issuance
        # Subtest: should issue certificate with correct TTL
        ok 1 - should issue certificate with correct TTL
          ---
          duration_ms: 9.582611
          ...
        # Subtest: should reject TTL > 24 hours
        ok 2 - should reject TTL > 24 hours
          ---
          duration_ms: 0.761816
          ...
        # Subtest: should default to 4-hour TTL
        ok 3 - should default to 4-hour TTL
          ---
          duration_ms: 0.897377
          ...
        # Subtest: should calculate correct renewal window (30 min before expiry)
        ok 4 - should calculate correct renewal window (30 min before expiry)
          ---
          duration_ms: 1.005867
          ...
        1..4
    ok 1 - Certificate Issuance
      ---
      duration_ms: 37.001795
      type: 'suite'
      ...
    # Subtest: Certificate Revocation
        # Subtest: should mark certificate as revoked
        ok 1 - should mark certificate as revoked
          ---
          duration_ms: 0.57609
          ...
        # Subtest: should add fingerprint to revoked set
        ok 2 - should add fingerprint to revoked set
          ---
          duration_ms: 0.371651
          ...
        1..2
    ok 2 - Certificate Revocation
      ---
      duration_ms: 1.514773
      type: 'suite'
      ...
    # Subtest: Kill-Switch: Revoke All for Participant
        # Subtest: should revoke all certificates for a participant
        ok 1 - should revoke all certificates for a participant
          ---
          duration_ms: 0.543443
          ...
        1..1
    ok 3 - Kill-Switch: Revoke All for Participant
      ---
      duration_ms: 0.916886
      type: 'suite'
      ...
    # Subtest: Certificate Validation
        # Subtest: should reject revoked certificates
        ok 1 - should reject revoked certificates
          ---
          duration_ms: 0.483027
          ...
        # Subtest: should reject expired certificates
        ok 2 - should reject expired certificates
          ---
          duration_ms: 0.480041
          ...
        # Subtest: should accept valid certificates
        ok 3 - should accept valid certificates
          ---
          duration_ms: 0.385884
          ...
        1..3
    ok 4 - Certificate Validation
      ---
      duration_ms: 15.547046
      type: 'suite'
      ...
    # Subtest: Revocation Bounds for Evidence Bundle
        # Subtest: should calculate worst-case revocation window
        ok 1 - should calculate worst-case revocation window
          ---
          duration_ms: 0.494075
          ...
        # Subtest: should return correct bounds object
        ok 2 - should return correct bounds object
          ---
          duration_ms: 0.457448
          ...
        1..2
    ok 5 - Revocation Bounds for Evidence Bundle
      ---
      duration_ms: 1.271119
      type: 'suite'
      ...
    # Subtest: Suspended Participant Protection
        # Subtest: should block certificate issuance for suspended participant
        ok 1 - should block certificate issuance for suspended participant
          ---
          duration_ms: 0.446897
          ...
        1..1
    ok 6 - Suspended Participant Protection
      ---
      duration_ms: 0.74798
      type: 'suite'
      ...
    1..6
ok 37 - ShortLivedCertificateManager
  ---
  duration_ms: 58.857159
  type: 'suite'
  ...
# Subtest: CertificateError
    # Subtest: should have correct error codes
    ok 1 - should have correct error codes
      ---
      duration_ms: 4.58204
      ...
    1..1
ok 38 - CertificateError
  ---
  duration_ms: 4.826788
  type: 'suite'
  ...
# Subtest: TrustFabric (SEC-FIX)
    # Subtest: TrustViolationError
        # Subtest: should have correct error codes defined
        ok 1 - should have correct error codes defined
          ---
          duration_ms: 1.653089
          ...
        # Subtest: should extend Error with correct name
        ok 2 - should extend Error with correct name
          ---
          duration_ms: 2.749409
          ...
        1..2
    ok 1 - TrustViolationError
      ---
      duration_ms: 8.159945
      type: 'suite'
      ...
    # Subtest: Implementation Verification
        # Subtest: should exist and be readable
        ok 1 - should exist and be readable
          ---
          duration_ms: 1.123392
          ...
        # Subtest: should use async resolveIdentity
        ok 2 - should use async resolveIdentity
          ---
          duration_ms: 2.715768
          ...
        # Subtest: should import and use LRUCache
        ok 3 - should import and use LRUCache
          ---
          duration_ms: 0.614994
          ...
        # Subtest: should check revoked status
        ok 4 - should check revoked status
          ---
          duration_ms: 0.526015
          ...
        # Subtest: should check expiry
        ok 5 - should check expiry
          ---
          duration_ms: 0.494065
          ...
        # Subtest: should check participant status
        ok 6 - should check participant status
          ---
          duration_ms: 0.61589
          ...
        # Subtest: should check environment binding
        ok 7 - should check environment binding
          ---
          duration_ms: 0.730947
          ...
        # Subtest: should use queryAsRole for scoped DB access
        ok 8 - should use queryAsRole for scoped DB access
          ---
          duration_ms: 0.580358
          ...
        # Subtest: should have stampede avoidance (inflight map)
        ok 9 - should have stampede avoidance (inflight map)
          ---
          duration_ms: 0.52472
          ...
        # Subtest: should have negative cache
        ok 10 - should have negative cache
          ---
          duration_ms: 2.650476
          ...
        1..10
    ok 2 - Implementation Verification
      ---
      duration_ms: 21.572869
      type: 'suite'
      ...
    1..2
ok 39 - TrustFabric (SEC-FIX)
  ---
  duration_ms: 30.949365
  type: 'suite'
  ...
# {"level":30,"time":1768711028343,"system":"symphony","msg":"Configuration guard passed."}
# Subtest: VerifyIdentity (Phase 7B Hardening)
    # Subtest: should verify a valid CLIENT identity
    ok 1 - should verify a valid CLIENT identity # SKIP
      ---
      duration_ms: 1.672015
      ...
    # Subtest: should verify a valid SERVICE identity
    ok 2 - should verify a valid SERVICE identity # SKIP
      ---
      duration_ms: 0.338923
      ...
    # Subtest: should verify a valid USER identity at Ingest boundary
    ok 3 - should verify a valid USER identity at Ingest boundary # SKIP
      ---
      duration_ms: 10.715541
      ...
    # Subtest: should REJECT service identity if mTLS fingerprint mismatches
    ok 4 - should REJECT service identity if mTLS fingerprint mismatches
      ---
      duration_ms: 24.096866
      ...
    # Subtest: should REJECT service identity if mTLS fingerprint missing from envelope
    ok 5 - should REJECT service identity if mTLS fingerprint missing from envelope
      ---
      duration_ms: 7.876944
      ...
    # Subtest: should PREVENT USER LAUNDERING: reject user envelope at internal service boundary
    ok 6 - should PREVENT USER LAUNDERING: reject user envelope at internal service boundary
      ---
      duration_ms: 18.52648
      ...
    # Subtest: should REJECT user identity if issuer is not ingest-api
    ok 7 - should REJECT user identity if issuer is not ingest-api
      ---
      duration_ms: 1.273088
      ...
    # Subtest: should REJECT user identity if trustTier is not user
    ok 8 - should REJECT user identity if trustTier is not user
      ---
      duration_ms: 2.227554
      ...
    1..8
ok 40 - VerifyIdentity (Phase 7B Hardening)
  ---
  duration_ms: 3802.069018
  type: 'suite'
  ...
# {"level":40,"time":1768711030226,"system":"symphony","context":"test-context","errors":[{"path":"id","message":"Invalid UUID"},{"path":"amount","message":"Too small: expected number to be >0"},{"path":"currency","message":"Invalid option: expected one of \\"USD\\"|\\"EUR\\"|\\"GBP\\""}],"msg":"Input Validation Failure (HIGH-SEC-002)"}
# Subtest: Zod Middleware
    # Subtest: should validate correct input
    ok 1 - should validate correct input
      ---
      duration_ms: 13.743217
      ...
    # Subtest: should reject invalid input with detailed error
    ok 2 - should reject invalid input with detailed error
      ---
      duration_ms: 15.986012
      ...
    # Subtest: should reject missing required fields
    ok 3 - should reject missing required fields
      ---
      duration_ms: 1.382753
      ...
    # Subtest: should create reusable validator factory
    ok 4 - should create reusable validator factory
      ---
      duration_ms: 1.026049
      ...
    1..4
ok 41 - Zod Middleware
  ---
  duration_ms: 520.337293
  type: 'suite'
  ...
# {"level":40,"time":1768711030235,"system":"symphony","context":"partial-test","errors":[{"path":"amount","message":"Invalid input: expected number, received undefined"},{"path":"currency","message":"Invalid option: expected one of \\"USD\\"|\\"EUR\\"|\\"GBP\\""}],"msg":"Input Validation Failure (HIGH-SEC-002)"}
# {"level":30,"time":1768711025349,"pid":31232,"hostname":"DESKTOP-VV0116A","name":"ZombieRepairWorker","event":"REPAIR_CYCLE_COMPLETE","zombiesRepaired":1,"recordsEscalated":1,"attestationsReconciled":1}
# Subtest: ZombieRepairWorker
    # Subtest: runRepairCycle()
        # Subtest: should execute repair queries with correct SQL
        ok 1 - should execute repair queries with correct SQL
          ---
          duration_ms: 13.348319
          ...
        # Subtest: should define transaction boundaries
        ok 2 - should define transaction boundaries
          ---
          duration_ms: 1.773535
          ...
        # Subtest: should rollback on error
        ok 3 - should rollback on error
          ---
          duration_ms: 5.807144
          ...
        1..3
    ok 1 - runRepairCycle()
      ---
      duration_ms: 22.862145
      type: 'suite'
      ...
    # Subtest: getZombieCount()
        # Subtest: should return count from DB
        ok 1 - should return count from DB
          ---
          duration_ms: 11.459575
          ...
        1..1
    ok 2 - getZombieCount()
      ---
      duration_ms: 11.780799
      type: 'suite'
      ...
    1..2
ok 42 - ZombieRepairWorker
  ---
  duration_ms: 35.984447
  type: 'suite'
  ...
# {"level":50,"time":1768711025361,"pid":31232,"hostname":"DESKTOP-VV0116A","name":"ZombieRepairWorker","error":"DB Failure","msg":"Repair cycle failed"}
# Sanity loading
# Subtest: Sanity
    # Subtest: should pass
    ok 1 - should pass
      ---
      duration_ms: 0.896576
      ...
    1..1
ok 43 - Sanity
  ---
  duration_ms: 3.794465
  type: 'suite'
  ...
1..43
# tests 218
# suites 107
# pass 206
# fail 9
# cancelled 0
# skipped 3
# todo 0
# duration_ms 167855.116955
