name: Symphony Security & CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  analyze:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Enforce Phase Monotonicity
        shell: bash
        run: |
          git fetch origin main
          CURRENT_PHASE=$(git show origin/main:.symphony/PHASE 2>/dev/null || echo "6")
          PROPOSED_PHASE=$(cat .symphony/PHASE 2>/dev/null || echo "6")
          echo "Current Phase (main): $CURRENT_PHASE"
          echo "Proposed Phase (branch): $PROPOSED_PHASE"
          if [ "$CURRENT_PHASE" -ge 7 ] && [ "$PROPOSED_PHASE" -lt "$CURRENT_PHASE" ]; then
            echo "::error::Phase downgrade detected. Phase is monotonic once Phase >=7."
            exit 1
          fi

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

  security-gates:
    name: Security Invariants & Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:18-alpine
        env:
          POSTGRES_USER: symphony
          POSTGRES_PASSWORD: symphony
          POSTGRES_DB: symphony
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U symphony -d symphony"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgres://symphony:symphony@localhost:5432/symphony
      PGSSLMODE: disable
      OUTBOX_EVIDENCE_DB_URL: ${{ secrets.OUTBOX_EVIDENCE_DB_URL }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: "recursive"
          fetch-depth: 0

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U symphony; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          echo "âœ… PostgreSQL is ready"

      - name: Apply Database Schema (migrations)
        run: |
          chmod +x scripts/db/reset_and_migrate.sh scripts/db/migrate.sh
          scripts/db/reset_and_migrate.sh

      # -------------------- PaC: lock + submodule pin --------------------
      - name: Verify Policy Lock (PaC)
        run: bash scripts/ci/verify_policy_lock.sh

      - name: Block Unapproved Policy Changes (PaC)
        run: |
          git fetch origin main --quiet
          git diff --name-only origin/main...HEAD | grep "^\.policies/" && (
            echo "âŒ Direct policy modification detected."
            echo "Policy updates must be approved upstream in org-security-policies."
            exit 1
          ) || true

      - name: Detect Phase
        run: |
          if [ -f .symphony/PHASE ]; then
            PHASE=$(cat .symphony/PHASE | tr -d '[:space:]')
          else
            PHASE=6
          fi
          echo "PHASE=$PHASE" >> $GITHUB_ENV

      - name: Use Node.js 20.19.6
        uses: actions/setup-node@v4
        with:
          node-version: 20.19.6
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Lint
        run: npm run lint -- --max-warnings=0

      - name: Install ripgrep
        run: sudo apt-get update && sudo apt-get install -y ripgrep

      - name: DB Boundary Guardrails (Phase A + B)
        run: ENFORCE_NO_DB_QUERY=1 scripts/guardrails/db-role-guardrails.sh

      # -------------------- Migrated Checks (Legacy CI) --------------------
      - name: Check Kill-Switches
        run: scripts/ci/kill_switch_check.sh

      - name: Check Database Invariants
        run: scripts/ci/db_invariants.sh

      - name: Check Architecture Invariants
        run: scripts/ci/architecture_invariants.sh

      - name: Enforce Archive Guardrails
        run: scripts/ci/archive_guardrail.sh
      # ---------------------------------------------------------------------

      - name: Enforce RequestContext Safety
        run: |
          if grep -r "RequestContext.set" libs/ services/ | grep -v "libs/context/requestContext.ts"; then
            echo "::error::Forbidden RequestContext.set() usage detected. Use RequestContext.run() instead."
            exit 1
          fi

      - name: Run Security Gates (Invariant Checks)
        run: npm run security-check

      - name: Run Unit Tests
        run: npm test

      - name: Run Integration Tests
        run: node --conditions=test --import ./tests/loader.mjs --test tests/integration/*.spec.ts tests/integration/*.test.ts

      - name: Enforce DISPATCHING Regression Query
        run: |
          echo "ðŸ”Ž Checking invariant: no DISPATCHING attempts exist..."
          COUNT=$(psql "$DATABASE_URL" -tA -X -v ON_ERROR_STOP=1 -c \
            "SELECT COUNT(*) FROM public.payment_outbox_attempts WHERE state='DISPATCHING';")
          echo "DISPATCHING count: $COUNT"
          if [ "$COUNT" -ne 0 ]; then
            echo "::error::DISPATCHING attempts detected: $COUNT"
            exit 1
          fi

      - name: Run Compliance Verification
        run: npm run ci:compliance

      - name: Install Snyk CLI
        run: npm install -g snyk@latest

      - name: Snyk Security Scan (Phase-aware)
        shell: bash
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          if [ "$PHASE" -ge 7 ]; then
            echo "Phase 7: Enforcing Snyk"
            snyk test
          else
            echo "Phase 6: Advisory Snyk"
            snyk test || echo "::warning::Snyk findings or auth issue (Phase 6 advisory)"
          fi

      - name: Audit Dependencies (block on high+)
        run: npm audit --audit-level=high

      - name: Generate Evidence Bundle
        if: always()
        run: .ci/evidence/generate_evidence.sh

      - name: Compute Evidence Hash
        if: always()
        run: .ci/evidence/compute_hash.sh

      - name: Validate Evidence Schema (Ajv 2020 + formats v3)
        if: always()
        run: npm run ci:validate-evidence

      - name: Package Evidence Bundle
        if: always()
        run: .ci/evidence/package_bundle.sh

      - name: Upload Evidence Bundle
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: evidence-bundle
          path: |
            evidence-bundle.json
            evidence-bundle.sha256
            evidence-bundle-*.zip

      - name: Generate Outbox Evidence Bundle
        if: always()
        env:
          OUTBOX_EVIDENCE_DB_URL: ${{ env.DATABASE_URL }}
        run: scripts/reports/generate-outbox-evidence.sh

      - name: Upload Outbox Evidence Bundle
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: outbox-evidence
          path: reports/outbox-evidence/
          retention-days: 14

      - name: Upload Phase Evidence
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: phase-evidence
          path: |
            .symphony/PHASE
            logs/
            test-results/
